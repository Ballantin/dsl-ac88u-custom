#include <stdio.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>

#include "str.h"

int   failureCount = 0;

void vTest( const char *expected, const char *fmt, va_list args )
{
   char  buf[ 500 ];

#if 0
   vsprintf( buf, fmt, args );
#else
   vStrPrintf( buf, sizeof( buf ), fmt, args );
#endif

   if ( strcmp( buf, expected ) != 0 )
   {
      printf( "Format '%s' failed: Expected '%s',  got '%s'\n", fmt, expected, buf );
      failureCount++;
   }
}

void Test( const char *expected, const char *fmt, ... )
{
   va_list  args;

   va_start( args, fmt );
   vTest( expected, fmt, args );
   va_end( args );
}

int main( int argc,  char **argv )
{
   Test( "abc",         "abc" );

   Test( "-%-",         "-%%-" );

   Test( "--123--",        "--%s--",   "123" );
   Test( "--   123--",     "--%6s--",  "123" );
   Test( "--123   --",     "--%-6s--", "123" );
   Test( "--123456789--",  "--%6s--",  "123456789" );
   Test( "--123456789--",  "--%-6s--", "123456789" );

   Test( "--   123--",     "--%*s--",    6, "123" );
   Test( "--123   --",     "--%-*s--",   6, "123" );
   Test( "--123456789--",  "--%*s--",    6, "123456789" );
   Test( "--123456789--",  "--%-*s--",   6, "123456789" );
   
   Test( "--   123--",     "--%6.6s--",  "123" );
   Test( "--123   --",     "--%-6.6s--", "123" );
   Test( "--123456--",     "--%6.6s--",  "123456789" );
   Test( "--123456--",     "--%-6.6s--", "123456789" );
   
   Test( "--   123--",     "--%*.6s--",  6, "123" );
   Test( "--123   --",     "--%-*.6s--", 6, "123" );
   Test( "--123456--",     "--%*.6s--",  6, "123456789" );
   Test( "--123456--",     "--%-*.6s--", 6, "123456789" );
   
   Test( "--   123--",     "--%6.*s--",  6, "123" );
   Test( "--123   --",     "--%-6.*s--", 6, "123" );
   Test( "--123456--",     "--%6.*s--",  6, "123456789" );
   Test( "--123456--",     "--%-6.*s--", 6, "123456789" );
   
   Test( "--   123--",     "--%*.*s--",  6, 6, "123" );
   Test( "--123   --",     "--%-*.*s--", 6, 6, "123" );
   Test( "--123456--",     "--%*.*s--",  6, 6, "123456789" );
   Test( "--123456--",     "--%-*.*s--", 6, 6, "123456789" );
   
   Test( "--A--",    "--%c--",   'A' );
   Test( "--  A--",  "--%3c--",  'A' );
   Test( "--A  --",  "--%-3c--", 'A' );

   Test( "1",        "%d",    1 );
   Test( "     1",   "%6d",   1 );
   Test( "000001",   "%06d",  1 );
   Test( "1     ",   "%-6d",  1 );

   Test( "123",      "%2d",   123 );
   Test( "123",      "%02d",  123 );
   Test( "123",      "%-2d",  123 );

   Test( "-123",     "%2d",   -123 );
   Test( "-123",     "%02d",  -123 );
   Test( "-123",     "%-2d",  -123 );

   Test( "-1",       "%d",    -1 );
   Test( "    -1",   "%6d",   -1 );
   Test( "-00001",   "%06d",  -1 );
   Test( "-1    ",   "%-6d",  -1 );

   Test( "1",        "%u",    1 );
   Test( "     1",   "%6u",   1 );
   Test( "000001",   "%06u",  1 );
   Test( "1     ",   "%-6u",  1 );

   Test( "40000",    "%lu",   40000L );
   Test( " 40000",   "%6lu",  40000L );
   Test( "040000",   "%06lu", 40000L );
   Test( "40000 ",   "%-6lu", 40000L );

   Test( "40000",    "%ld",   40000L );
   Test( " 40000",   "%6ld",  40000L );
   Test( "040000",   "%06ld", 40000L );
   Test( "40000 ",   "%-6ld", 40000L );

   Test( "-40000",   "%ld",   -40000L );
   Test( "  -40000", "%8ld",  -40000L );
   Test( "-0040000", "%08ld", -40000L );
   Test( "-40000  ", "%-8ld", -40000L );

   Test( "32767",    "%d",    32767 );
   Test( "   32767", "%8d",   32767 );
   Test( "00032767", "%08d",  32767 );
   Test( "32767   ", "%-8d",  32767 );

   Test( "32767",    "%i",    32767 );
   Test( "   32767", "%8i",   32767 );
   Test( "00032767", "%08i",  32767 );
   Test( "32767   ", "%-8i",  32767 );

   Test( "-32768",   "%d",    -32768 );
   Test( "  -32768", "%8d",   -32768 );
   Test( "-0032768", "%08d",  -32768 );
   Test( "-32768  ", "%-8d",  -32768 );

   Test( "1",        "%u",    1 );
   Test( "     1",   "%6u",   1 );
   Test( "000001",   "%06u",  1 );
   Test( "1     ",   "%-6u",  1 );

   Test( "a",        "%x",    10 );
   Test( "     a",   "%6x",   10 );
   Test( "00000a",   "%06x",  10 );
   Test( "a     ",   "%-6x",  10 );

   Test( " 01",       "%3.2X", 1 );

   Test( "A",        "%X",    10 );
   Test( "     A",   "%6X",   10 );
   Test( "00000A",   "%06X",  10 );
   Test( "A     ",   "%-6X",  10 );

   Test( "12",       "%o",    10 );
   Test( "    12",   "%6o",   10 );
   Test( "000012",   "%06o",  10 );
   Test( "12    ",   "%-6o",  10 );

   Test( "1010",     "%b",    10 );
   Test( "  1010",   "%6b",   10 );
   Test( "001010",   "%06b",  10 );
   Test( "1010  ",   "%-6b",  10 );

   Test( "a0000",    "%lx",   0xa0000 );
   Test( " a0000",   "%6lx",  0xa0000 );
   Test( "0a0000",   "%06lx", 0xa0000 );
   Test( "a0000 ",   "%-6lx", 0xa0000 );

   Test( "A0000",    "%lX",   0xa0000 );
   Test( " A0000",   "%6lX",  0xa0000 );
   Test( "0A0000",   "%06lX", 0xa0000 );
   Test( "A0000 ",   "%-6lX", 0xa0000 );

   Test( "2400000",  "%lo",   0xa0000 );
   Test( " 2400000", "%8lo",  0xa0000 );
   Test( "02400000", "%08lo", 0xa0000 );
   Test( "2400000 ", "%-8lo", 0xa0000 );

   Test( "10100000000000000000",     "%lb",    0xa0000 );
   Test( "  10100000000000000000",   "%22lb",  0xa0000 );
   Test( "0010100000000000000000",   "%022lb", 0xa0000 );
   Test( "10100000000000000000  ",   "%-22lb", 0xa0000 );

   if ( failureCount == 0 )
   {
      printf( "All tests passed\n" );
      exit( 0 );
   }

   exit( 1 );
   return 0;
}

