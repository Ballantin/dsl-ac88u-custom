/*
 * --------------------------------------------------------------------------------
 * (c) Copyright 2008, SiTel Semiconductor BV
 * All Rights Reserved
 * --------------------------------------------------------------------------------
 * SITEL SEMICONDUCTOR CONFIDENTIAL
 * --------------------------------------------------------------------------------
 * This code includes Confidential, Proprietary Information and is a Trade 
 * Secret of Sitel Semiconductor BV. All use, disclosure, and/or reproduction 
 * is prohibited unless authorized in writing.
 * --------------------------------------------------------------------------------
 *                                                                             
 * Description: test the DECTIP interrupts
 *                                                                             
 * --------------------------------------------------------------------------------
 * Synchronicity history: 
 *
 * $Log: dectip_int.c.rca $
 *
 *  Revision: 1.12 Fri Feb 13 23:06:37 2009 snijders
 *  Added official SiTel header.
 *
 * --------------------------------------------------------------------------------
 */

#define BMC_BANK_ADDR           (0x1000)
#define BMC_CTRL_RD_ADDR        (0x0010)
#define USE_DIP_INTERRUPT

/*========================== Include files ==================================*/
#include "sitel_io.h"
#include "sitel_functions.h"
#include "simul.h"
#include "dip.h"

#include "xdrvIntCtrl.h"
#include "63268_intr.h"
#include "bcm63268Dect.h"
#include <xdrvGlobalInterrupt.h>

#include "gen2dsp_int_0x4C00_0x5000.PM"
#include "gen2dsp_int_0x4C00_0x5000.DM"

#define SEQ(adr,opc,opr)        SetWord((SEQUENCER_RAM_START + (adr<<1)),(opc)<<8|(opr));

#define    TEST_VALUE 0x0002

#define CR16_VECTOR1 0x0001             // Vectors generated by one of the DSP's
#define CR16_VECTOR2 0x0002
#define CR16_VECTOR3 0x0004
#define CR16_VECTOR4 0x0008
#define CR16_VECTOR5 0x0010
#define CR16_VECTOR6 0x0020
#define CR16_VECTOR7 0x0040
#define CR16_VECTOR8 0x0080
#define CR16_VECTOR9 0x0100
#define CR16_VECTOR10 0x0200
#define CR16_VECTOR11 0x0400
#define CR16_VECTOR12 0x0800
#define CR16_VECTOR13 0x1000
#define CR16_VECTOR14 0x2000
#define CR16_VECTOR15 0x4000
#define CR16_VECTOR16 0x8000

WORD    irq_result, irq2_result;
WORD    vector;
BYTE    dip_irq;
BYTE    dip_irq_cnt = 0;
BYTE    brk_dip_cnt;
BYTE    br_dip_cnt; // TEMP: For alternate sequencer

void    program_sequencer(void);

volatile enum
{
        busy,
        ready
}dip_test;

unsigned int *mask = (unsigned int*)0xB0000020;
unsigned int *status = (unsigned int*)0xB0000028;
unsigned int *shimStatus = (unsigned int*)(DECT_SHIM_CTRL_BASE + 0x14);
unsigned int *shimMask = (unsigned int*)(DECT_SHIM_CTRL_BASE + 0x10);

extern void gprint(const char *fmt, unsigned long arg0, unsigned long arg1, unsigned long arg2);

void* memcpy(void *s1, void *s2, int len)
{
   char *t1 = s1;
   char *t2 = s2;
   
   if ( t1 && t2 && (len > 0) )
   {
      while( len-- > 0 )
      {
         *t1++ = *t2++;
      }
   }
   
   return s1;
}

BOOL RunTest(void)
{

WORD CR16_vector[16] = {CR16_VECTOR1,CR16_VECTOR2,CR16_VECTOR3,CR16_VECTOR4,CR16_VECTOR5,CR16_VECTOR6,CR16_VECTOR7,CR16_VECTOR8,CR16_VECTOR9,CR16_VECTOR10,CR16_VECTOR11,CR16_VECTOR12,CR16_VECTOR13,CR16_VECTOR14,CR16_VECTOR15,CR16_VECTOR16};
    BOOL TstResult=TRUE; 
    int intnr;
    WORD CLKDSPDIV;
    WORD CLKCR16DIV;
    int p,pp, k;
    BYTE j;

    // *********************************************************************
    // Test A: Gen2DSP1 8kHz/16kHz/32kHz/DIP/DSP2/ CR16 interrupt test
    // *********************************************************************

    gprint("######## DECTIP_INT: In RunTest Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    SetWord(DSP_INT_MASK_REG, 0xFFFF);
    SetWord(DSP_INT_PRIO1_REG, 0x0005);                      // prio settings
    SetWord(DSP_CTRL_REG, 0x0004);             // dsp enable
    SetWord(DSP_CTRL_REG, 0x0014);             // dsp enable

    gprint("######## DECTIP_INT: Setup counter Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    // Setup Main Counter
    SetWord(DSP_MAIN_SYNC1_REG, 0x3210);           // sync enable
    SetWord(DSP_MAIN_CTRL_REG, 0x100);             // mian counter free running mode
   
    gprint("######## DECTIP_INT: Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    gprint("######## DECTIP_INT: ShimMask = 0x%x\n", *shimMask, 0, 0);
 
    // CHECK 8KHZ TO DSP INT0
    SetWord(DEBUGGER_REG, 0x1001);
    SetWord((SHARED_RAM_START + 0x2100) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0077);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                    
    while ((GetWord(SHARED_RAM_START+0x2100))==0x0000) 
    {
       gprint("######## DECTIP_INT: Waiting for Int Status = 0x%x, ShimStatus = 0x%x\n", *status, *shimStatus, 0);
    }   // Wait until INT

    gprint("######## DECTIP_INT: After Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    if ((GetWord(SHARED_RAM_START+0x2100))!=0x0001) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 8KHZ TO DSP INT1
    SetWord(DEBUGGER_REG, 0x1002);
    SetWord((SHARED_RAM_START + 0x2102) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0707);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                   
    while ((GetWord(SHARED_RAM_START+0x2102))==0x0000) 
    {
        gprint("######## DECTIP_INT1: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT
    if ((GetWord(SHARED_RAM_START+0x2102))!=0x0002) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 8KHZ TO DSP INT2
    SetWord(DEBUGGER_REG, 0x1003);
    SetWord((SHARED_RAM_START + 0x2104) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0770);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                  
    while ((GetWord(SHARED_RAM_START+0x2104))==0x0000) {;}   // Wait until INT
    if ((GetWord(SHARED_RAM_START+0x2104))!=0x0003) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 8KHZ TO DSP INT3
    SetWord(DEBUGGER_REG, 0x1004);
    SetWord((SHARED_RAM_START + 0x2106) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0077);                 
    while ((GetWord(SHARED_RAM_START+0x2106))==0x0000)
    {
        gprint("######## DECTIP_INT2: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2106))!=0x0004) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 8KHZ TO DSP INT4
    SetWord(DEBUGGER_REG, 0x1005);
    SetWord((SHARED_RAM_START + 0x2108) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0707);                   
    while ((GetWord(SHARED_RAM_START+0x2108))==0x0000)
    {
        gprint("######## DECTIP_INT3: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2108))!=0x0005) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 8KHZ TO DSP INT5
    SetWord(DEBUGGER_REG, 0x1006);
    SetWord((SHARED_RAM_START + 0x210A) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0770);                  
    while ((GetWord(SHARED_RAM_START+0x210A))==0x0000)
    {
        gprint("######## DECTIP_INT4: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x210A))!=0x0006) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
 
    // CHECK 16KHZ TO DSP INT0
    SetWord(DEBUGGER_REG, 0x2001);
    SetWord((SHARED_RAM_START + 0x2100) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0177);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                     
    while ((GetWord(SHARED_RAM_START+0x2100))==0x0000)
    {
        gprint("######## DECTIP_INT5: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2100))!=0x0001) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 16KHZ TO DSP INT1
    SetWord(DEBUGGER_REG, 0x2002);
    SetWord((SHARED_RAM_START + 0x2102) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0717);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                    
    while ((GetWord(SHARED_RAM_START+0x2102))==0x0000)
    {
        gprint("######## DECTIP_INT6: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2102))!=0x0002) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 16KHZ TO DSP INT2
    SetWord(DEBUGGER_REG, 0x2003);
    SetWord((SHARED_RAM_START + 0x2104) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0771);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);                   
    while ((GetWord(SHARED_RAM_START+0x2104))==0x0000)
    {
        gprint("######## DECTIP_INT7: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2104))!=0x0003) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 16KHZ TO DSP INT3
    SetWord(DEBUGGER_REG, 0x2004);
    SetWord((SHARED_RAM_START + 0x2106) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0177);                  
    while ((GetWord(SHARED_RAM_START+0x2106))==0x0000)
    {
        gprint("######## DECTIP_INT8: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2106))!=0x0004) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 16KHZ TO DSP INT4
    SetWord(DEBUGGER_REG, 0x2005);
    SetWord((SHARED_RAM_START + 0x2108) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0717);                 
    while ((GetWord(SHARED_RAM_START+0x2108))==0x0000)
    {
        gprint("######## DECTIP_INT9: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2108))!=0x0005) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 16KHZ TO DSP INT5
    SetWord(DEBUGGER_REG, 0x2006);
    SetWord((SHARED_RAM_START + 0x210A) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0771);                
    while ((GetWord(SHARED_RAM_START+0x210A))==0x0000)
    {
        gprint("######## DECTIP_INT10: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x210A))!=0x0006) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT0
    SetWord(DEBUGGER_REG, 0x3001);
    SetWord((SHARED_RAM_START + 0x2100) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0277);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);               
    while ((GetWord(SHARED_RAM_START+0x2100))==0x0000)
    {
        gprint("######## DECTIP_INT11: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2100))!=0x0001) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT1
    SetWord(DEBUGGER_REG, 0x3002);
    SetWord((SHARED_RAM_START + 0x2102) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0727);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);              
    while ((GetWord(SHARED_RAM_START+0x2102))==0x0000)
    {
        gprint("######## DECTIP_INT12: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2102))!=0x0002) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT2
    SetWord(DEBUGGER_REG, 0x3003);
    SetWord((SHARED_RAM_START + 0x2104) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0772);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0777);             
    while ((GetWord(SHARED_RAM_START+0x2104))==0x0000)
    {
        gprint("######## DECTIP_INT13: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2104))!=0x0003) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT3
    SetWord(DEBUGGER_REG, 0x3004);
    SetWord((SHARED_RAM_START + 0x2106) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0277);            
    while ((GetWord(SHARED_RAM_START+0x2106))==0x0000)
    {
        gprint("######## DECTIP_INT14: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2106))!=0x0004) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT4
    SetWord(DEBUGGER_REG, 0x3005);
    SetWord((SHARED_RAM_START + 0x2108) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0727);           
    while ((GetWord(SHARED_RAM_START+0x2108))==0x0000)
    {
        gprint("######## DECTIP_INT15: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2108))!=0x0005) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK 32KHZ TO DSP INT5
    SetWord(DEBUGGER_REG, 0x3006);
    SetWord((SHARED_RAM_START + 0x210A) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x0777);                      // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x0772);          
    while ((GetWord(SHARED_RAM_START+0x210A))==0x0000)
    {
        gprint("######## DECTIP_INT16: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x210A))!=0x0006) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    SetWord(DSP_CTRL_REG, 0x0000);                      // prio settings

    // CHECK DIP INT TO DSP with power down dip dsp
    SetWord(DEBUGGER_REG, 0x5001);
    SEQ(0x01,   WT     ,  0x05);
    SEQ(0x02,   U_VINT ,  0x10);
    SEQ(0x03,   BR     ,  0x01);
    SetWord((SHARED_RAM_START + 0x2100) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x477);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x577);    
    SetWord(DSP_CTRL_REG,0x0014 );                           // trigger+enable DSP1
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x2100))==0x0000)
    {
        gprint("######## DECTIP_INT17: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2100))!=0x0001) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
    SetWord(DIP_CTRL_REG,0x0080);                             // seq off

    // CHECK DIP INT TO DSP with power down dip
    SetWord(DEBUGGER_REG, 0x5002);
    SetWord((SHARED_RAM_START + 0x2102) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x747);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x777);    
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x2102))==0x0000)
    {
        gprint("######## DECTIP_INT18: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2102))!=0x0002) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
    SetWord(DIP_CTRL_REG,0x0080);                             // seq off

    // CHECK DIP INT TO DSP with power down dip
    SetWord(DEBUGGER_REG, 0x5003);
    SetWord((SHARED_RAM_START + 0x2104) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x774);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x777);    
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x2104))==0x0000)
    {
        gprint("######## DECTIP_INT19: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2104))!=0x0003) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK DIP INT TO DSP with power down dip
    SetWord(DEBUGGER_REG, 0x5004);
    SetWord((SHARED_RAM_START + 0x2106) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x777);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x477);    
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x2106))==0x0000)
    {
        gprint("######## DECTIP_INT20: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2106))!=0x0004) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK DIP INT TO DSP with power down dip
    SetWord(DEBUGGER_REG, 0x5005);
    SetWord((SHARED_RAM_START + 0x2108) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x777);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x747);    
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x2108))==0x0000)
    {
        gprint("######## DECTIP_INT21: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x2108))!=0x0005) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test

    // CHECK DIP INT TO DSP with power down dip
    SetWord(DEBUGGER_REG, 0x5006);
    SetWord((SHARED_RAM_START + 0x210A) , 0x0000);           // clear dsp interrupt results
    SetWord(DSP_INT_PRIO1_REG, 0x777);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x774);    
    SetWord(DIP_CTRL_REG,0x0000);                             // seq on
    while ((GetWord(SHARED_RAM_START+0x210A))==0x0000)
    {
        gprint("######## DECTIP_INT22: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    }   // Wait until INT

    if ((GetWord(SHARED_RAM_START+0x210A))!=0x0006) 
     {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
    SetWord(DIP_CTRL_REG,0x0080);                             // seq off

    // CHECK CR16 INT TO DSP AND BACK
    SetWord(DEBUGGER_REG, 0x6006);
    SetWord(DSP_INT_PRIO1_REG, 0x777);                       // prio settings
    SetWord(DSP_INT_PRIO2_REG, 0x775);          
    SetWord(DSP_INT_REG,0xFFFF);

    // Copy DSP1 Data
    SetWord(DSP_CTRL_REG, 0x0000);             // dsp disable
    for(p=0;p<DM_size_int;p++) {
     SetWord((SHARED_RAM_START+((DM_addr_int[p])<<1)),DM_val_int[p]);
    }
    SetWord(DSP_CTRL_REG, 0x0014);             // dsp enable
//    while ((GetWord(DSP_INT_REG))!=0xFFFF)
    while ((GetWord(DSP_INT_REG))!=0x0)
    {
        gprint("######## DECTIP_INT23: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
        gprint("GetWord(DSP_INT_REG) =0x%x\n", GetWord(DSP_INT_REG), 0, 0);
    }   // Wait until DSP1 is ready
    SetWord(DSP_INT_REG,0xFFFF );                            // trigger+enable DSP1

#if 0
    intnr=0;
    SetWord((SHARED_RAM_START + 0x2110),0x0000);
    while (intnr<=15) 
    {
     SetWord(DEBUGGER_REG, 0x7007);
     SetWord(DSP_INT_MASK_REG, CR16_vector[intnr]);
     SetWord((SHARED_RAM_START + 0x210A),0x0000);
     SetWord(DSP_CTRL_REG, 0x0014);                                      // dsp enable
     while (GetWord(DSP_INT_REG) != CR16_vector[intnr])
     {
        gprint("######## DECTIP_INT24: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
     }   // Wait until INT

     if (GetWord(DSP_INT_REG) != CR16_vector[intnr])
      {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
     SetWord(DSP_INT_REG, CR16_vector[intnr]);
     if (GetWord(DSP_INT_REG) != 0x0000)
      {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
     if (GetWord((SHARED_RAM_START + 0x2110)) != 0xFFFF)
      {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
     SetWord((SHARED_RAM_START + 0x2110),0x0000);
     if (GetWord((SHARED_RAM_START + 0x210A)) != 6)
      {SetWord(RESULT_REG, TEST_VALUE);  TstResult=FALSE;}               // check test
     intnr++;
    }
#endif

    SetWord(DSP_CTRL_REG, 0x0000);                                       // dsp disable

    program_sequencer();

    dip_test = busy;

    SetWord(DIP_CTRL_REG, 0x0010);                                         // start seq

    for (p=0;p<28;p++) {
      SetByte((SHARED_RAM_START + 0x2120 + p),0x00);                         // init with zeroes
      }

     WORD s;

      while ((s = GetWord(DIP_CTRL_REG)) != 0x01) {gprint("######## DECTIP_INT25: Int ret = 0x%x, Mask = 0x%x\n", s, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt,      WT,     0x01); // TEMP: alternate sequencer      
      while (GetWord(DIP_CTRL_REG) != 0x02) {gprint("######## DECTIP_INT26: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+2,    WT,     0x01); //
      while (GetWord(DIP_CTRL_REG) != 0x04) {gprint("######## DECTIP_INT27: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+4,    WT,     0x01); //
      while (GetWord(DIP_CTRL_REG) != 0x08) {gprint("######## DECTIP_INT28: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+6,    WT,     0x01); //
      while (GetWord(DIP_CTRL_REG) != 0x01) {gprint("######## DECTIP_INT29: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+8,    WT,     0x01); //      
      while (GetWord(DIP_CTRL_REG) != 0x02) {gprint("######## DECTIP_INT30: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+10,    WT,     0x01); //
      while (GetWord(DIP_CTRL_REG) != 0x04) {gprint("######## DECTIP_INT31: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+12,    WT,     0x01); //
      while (GetWord(DIP_CTRL_REG) != 0x08) {gprint("######## DECTIP_INT32: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      *mask |= (1<<7);
      SEQ(br_dip_cnt+14,    WT,     0x01); //

      
   while(dip_test == busy)
     {gprint("######## DECTIP_INT33: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);;}

// As the ISR works by edge detection in this environment, 
// this change of vector should be polled as the interrupt stays high 
#if 0
      while (GetWord(DIP_CTRL_REG) != 0x02) {gprint("######## DECTIP_INT34: Int Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);};
      SetWord(DEBUGGER_REG, 0x8019);
      SetByte(SHARED_RAM_START + 0x2120 + 0x19, 0x19);
#endif

   SetWord(DIP_CTRL_REG, 0x0080);

   /* p matches number of INTs tested above */
   for (p=0;p<23;p++) {
      if (GetByte(SHARED_RAM_START + 0x2120 + p) != p) return FALSE;        
   }
    
gprint("Completed DECTIP INT testing!\n", 0, 0, 0);

   return TstResult;
    
}
#if 0 // TEMP: Try alternate sequencer
void  program_sequencer()
{
    BYTE  dip_cnt;
    BYTE  br_dip_cnt;

    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 0, 0x21);    //PP MODE, 2 errors accepted in Sfield
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 1, 0xFF);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 2, 0);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 3, 0);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 4, 0x0F);    //WINDOW SFIELD
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 5, 0x88);    //NO SCRAMBLING, NO ENCRYPTION
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 6, 0x00);

    dip_cnt = 1;

    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT0, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT1, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT2, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT3, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    U_INT0, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT1, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT2, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT3, 0x00);
    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x03);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x07);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x0F);
    SEQ(dip_cnt++,    WT,     0x01);

    brk_dip_cnt = dip_cnt;
    SEQ(dip_cnt++,    BRK,    0x00);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    BK_MC,  BMC_BANK_ADDR>>8);
    SEQ(dip_cnt++,    B_RC,   BMC_CTRL_RD_ADDR);
    SEQ(dip_cnt++,    WT,     19);
    SEQ(dip_cnt++,    B_SR,    0);
    SEQ(dip_cnt++,    WT,     0x20);
    SEQ(dip_cnt++,    B_RST,0x00);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    WT,     0x01);

    br_dip_cnt = dip_cnt;
    SEQ(dip_cnt++,    BR,     dip_cnt);
}
#endif
void  program_sequencer()
{
    BYTE  dip_cnt;

    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 0, 0x21);    //PP MODE, 2 errors accepted in Sfield
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 1, 0xFF);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 2, 0);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 3, 0);
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 4, 0x0F);    //WINDOW SFIELD
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 5, 0x88);    //NO SCRAMBLING, NO ENCRYPTION
    SetByte(SHARED_RAM_START + BMC_BANK_ADDR + BMC_CTRL_RD_ADDR + 6, 0x00);

    dip_cnt = 1;

    SEQ(dip_cnt++,    WT,     0x01);
    SEQ(dip_cnt++,    U_INT0, 0x01);
br_dip_cnt = dip_cnt;
    SEQ(dip_cnt++,    BR,     br_dip_cnt);
    SEQ(dip_cnt++,    U_INT1, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+2 );
    SEQ(dip_cnt++,    U_INT2, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+4);
    SEQ(dip_cnt++,    U_INT3, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+6);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+8);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+10);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+12);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+14);

    SEQ(dip_cnt++,    U_INT0, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+16);
    SEQ(dip_cnt++,    U_INT1, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+18);
    SEQ(dip_cnt++,    U_INT2, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+20);
    SEQ(dip_cnt++,    U_INT3, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+22);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+24);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+26);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+28);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+30);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+32);
    SEQ(dip_cnt++,    U_VINT, 0x03);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+34);
    SEQ(dip_cnt++,    U_VINT, 0x07);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+36);
    SEQ(dip_cnt++,    U_VINT, 0x0F);
    SEQ(dip_cnt++,    BR,     br_dip_cnt+38);

    brk_dip_cnt = dip_cnt;
    SEQ(dip_cnt++,    BRK,    0x00);

    SEQ(dip_cnt++,    U_VINT, 0x01);
    SEQ(dip_cnt++,    WT,     0x1);
    SEQ(dip_cnt++,    U_VINT, 0x02);
    SEQ(dip_cnt++,    WT,     0x1);
    SEQ(dip_cnt++,    U_VINT, 0x04);
    SEQ(dip_cnt++,    WT,     0x1);
    SEQ(dip_cnt++,    U_VINT, 0x08);
    SEQ(dip_cnt++,    WT,     0x1);

// Interrupt on sync test
//    SEQ(dip_cnt++,    BK_MC,  BMC_BANK_ADDR>>8);
//    SEQ(dip_cnt++,    B_RC,   BMC_CTRL_RD_ADDR);
//    SEQ(dip_cnt++,    WT,     19);
//    SEQ(dip_cnt++,    B_SR,    0);
//    SEQ(dip_cnt++,    WT,   0x20);
//    SEQ(dip_cnt++,    B_RST,0x00);

// simultaneous interrupt1 read and interrupt2 set
//    SEQ(dip_cnt++,    U_VINT, 0x01);
//    SEQ(dip_cnt++,    WT,     0x01);
//    SEQ(dip_cnt++,    U_VINT, 0x02);
//    SEQ(dip_cnt++,    WT,     0x01);

    SEQ(dip_cnt++,    BR,     --dip_cnt);
}

// ISR for DSP interrupt
static unsigned int isr_dsp_int( XDRV_INT_CTRL_ISR_PARM isrData ) 
{
  /* Not used. */
  (void) isrData; 
  //gprint("######## Enter DSP ISR: *mask=0x%08x, *status=0x%08x, %d \n", *mask, *status, 0);
  SetWord(DEBUGGER_REG, 0x5555);
  SetWord((SHARED_RAM_START + 0x2110),0xFFFF);
  SetWord(DSP_INT_REG, 0xFFFF);                 // clear all interrupts

   if ( DECT_CTRL->dect_shm_irq_status & 0x2 )
   {
      gprint("\nTP0: DECT SHIM Handler DSP_IRQ_OUT\n", 0, 0, 0);
      DECT_CTRL->dect_shm_irq_status |= 0x2;
   }

  xdrvIntCtrlEnableInterrupt( INTERRUPT_ID_DECT_0 );  
  //gprint("######## Exit DSP ISR: *mask=0x%08x, *status=0x%08x, %d \n", *mask, *status, 0);

  return( 0 );
}

// ISR for DIP interrupt
static unsigned int isr_dip_int( XDRV_INT_CTRL_ISR_PARM isrData ) 
{
   WORD q;
   /* Not used. */
  (void) isrData; 
     
   dip_irq_cnt++;
   gprint("######## Enter DIP ISR: *mask=0x%08x, *status=0x%08x, dip_irq_cnt=%d \n", *mask, *status, dip_irq_cnt);

   SetWord(DEBUGGER_REG, 0x8000 + dip_irq_cnt);
   if (dip_irq_cnt < 9) {
// Here the interrupts are checked on polling method
     SetByte((SHARED_RAM_START + 0x2120 + dip_irq_cnt),dip_irq_cnt);
  // *mask &= ~(1<<7);  Linux interrupt handling already disables mask
  gprint("######## DIP ISR: dip_status_reg=0x%08x\n", GetWord(DIP_STATUS_REG), 0, 0); 	 
   }
   else {
     if (dip_irq_cnt < 0x15) {
// Now the interrupts are cleared in the ISR
       dip_irq = GetWord(DIP_CTRL_REG);
  gprint("######## DIP ISR < 0x15: dip_irq=0x%08x\n", dip_irq, 0, 0);      
       if (dip_irq == 0x01 && dip_irq_cnt == 0x09) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+16,      WT,     0x01);
       }
       if (dip_irq == 0x02 && dip_irq_cnt == 0x0A) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+18,      WT,     0x01);
       }
       if (dip_irq == 0x04 && dip_irq_cnt == 0x0B) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+20,      WT,     0x01);
       }
       if (dip_irq == 0x08 && dip_irq_cnt == 0x0C) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+22,      WT,     0x01);
       }

       if (dip_irq == 0x01 && dip_irq_cnt == 0x0D) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+24,      WT,     0x01);
       }
       if (dip_irq == 0x02 && dip_irq_cnt == 0x0E)
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+26,      WT,     0x01);
       }
       if (dip_irq == 0x04 && dip_irq_cnt == 0x0F) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+28,      WT,     0x01);
       }
       if (dip_irq == 0x08 && dip_irq_cnt == 0x10) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+30,      WT,     0x01);
       }

       if (dip_irq == 0x01 && dip_irq_cnt == 0x11)
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+32,      WT,     0x01);
       }
       if (dip_irq == 0x03 && dip_irq_cnt == 0x12) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+34,      WT,     0x01);
       }
       if (dip_irq == 0x07 && dip_irq_cnt == 0x13)
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+36,      WT,     0x01);
       }
       if (dip_irq == 0x0F && dip_irq_cnt == 0x14) 
       {
          SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
          SEQ(br_dip_cnt+38,      WT,     0x01);
       }
     }
     else {
       if (dip_irq_cnt == 0x15) {
// Check BRK interrupt, Break reset needs to wait some time as this interrupt is synchronised towards 1MHz clock generation
         dip_irq = GetWord(DIP_CTRL_REG);
  gprint("######## DIP ISR = 0x15: dip_irq=0x%08x\n", dip_irq, 0, 0);          
         if (dip_irq == 0x20 && dip_irq_cnt == 0x15) {SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);}
         SEQ(brk_dip_cnt,  WT,     0x01);
         for (q=0;q<100;q++) {
           {;}
         }
         SetWord(DIP_CTRL_REG, 0x0030);
       }
       if (dip_irq_cnt == 0x16) {
// Check cumulative interrupt from 4 interrupt vector bits. A wait is requirred to let let 4 interrupts (@1MHz clock) pass
         for (q=0;q<1000;q++) {
           {;}
         }
         dip_irq = GetWord(DIP_CTRL_REG);
  gprint("######## DIP ISR = 0x16: dip_irq=0x%08x\n", dip_irq, 0, 0);          
         if (dip_irq == 0x0F && dip_irq_cnt == 0x16) 
         {
            SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt); 
            dip_test = ready;   
         }
       }
       
#if 0 // Removal interrupt on sync test to be able to use simpler tdo-rdi model
       if (dip_irq_cnt == 0x17) {
// Check Interrupt on S-field detection
         dip_irq = GetWord(DIP_CTRL_REG);
         if (dip_irq == 0x10 && dip_irq_cnt == 0x17) {SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);}
       }
       if (dip_irq_cnt == 0x18) {
// Check critical set / clear moment. Here Interrupt 1 is cleared exactly at the moment interrupt 2 is set
         for (q=0;q<285;q++) {
           {;}
         }
         dip_irq = GetWord(DIP_CTRL_REG);         
         if (dip_irq == 0x01 && dip_irq_cnt == 0x18) {SetByte(SHARED_RAM_START + 0x2120 + dip_irq_cnt, dip_irq_cnt);
                                                      dip_test = ready;}
       }
#endif

      } // 2nd else

      xdrvIntCtrlEnableInterrupt( INTERRUPT_ID_DECT_1 );  // Re-enable interrupts when we are pass the first 8 polling
   } // 1st else

  return( 0 );
}

void dectIrqTestSetup()
{
   XDRV_GLOBAL_INTERRUPT_LOCK   lock;
   
   
   /* Use SWAP based access to keep things simple */
   DECT_CTRL->dect_shm_ctrl &= ~AHB_SWAP_MASK;  
   DECT_CTRL->dect_shm_ctrl |= AHB_SWAP_ACCESS;
   
   /* Enable DSP interrupt in DECT_SHM_IRQ_ENABLE register */
   DECT_CTRL->dect_shm_irq_enable |= 0x7303;

   dip_irq_cnt=0;
   
   xdrvGlobalInterruptDisable( &lock );
   xdrvIntCtrlDisableInterrupt( INTERRUPT_ID_DECT_0 );

   xdrvIntCtrlInstallInterrupt( INTERRUPT_ID_DECT_0,
                                isr_dsp_int,
                                NULL /* isr parm */ );

   xdrvIntCtrlEnableInterrupt( INTERRUPT_ID_DECT_0 );
   xdrvGlobalInterruptRestore( &lock );


   xdrvGlobalInterruptDisable( &lock );
   xdrvIntCtrlDisableInterrupt( INTERRUPT_ID_DECT_1 );

   xdrvIntCtrlInstallInterrupt( INTERRUPT_ID_DECT_1,
                                isr_dip_int,
                                NULL /* isr parm */ );

   xdrvIntCtrlEnableInterrupt( INTERRUPT_ID_DECT_1 );
   xdrvGlobalInterruptRestore( &lock );   
   
}

void dectIrqTestDisable()
{
   XDRV_GLOBAL_INTERRUPT_LOCK   lock;
   
   xdrvGlobalInterruptDisable( &lock );
   xdrvIntCtrlDisableInterrupt( INTERRUPT_ID_DECT_0 );
   xdrvIntCtrlDisableInterrupt( INTERRUPT_ID_DECT_1 );
   xdrvIntCtrlUninstallInterrupt( INTERRUPT_ID_DECT_0 ); 
   xdrvIntCtrlUninstallInterrupt( INTERRUPT_ID_DECT_1 );
   xdrvGlobalInterruptRestore( &lock ); 
   
   dip_irq_cnt=0;
   
}

int dectip_int()
{
WORD CR16_vector[16] = {CR16_VECTOR1,CR16_VECTOR2,CR16_VECTOR3,CR16_VECTOR4,CR16_VECTOR5,CR16_VECTOR6,CR16_VECTOR7,CR16_VECTOR8,CR16_VECTOR9,CR16_VECTOR10,CR16_VECTOR11,CR16_VECTOR12,CR16_VECTOR13,CR16_VECTOR14,CR16_VECTOR15,CR16_VECTOR16};
    BOOL Result; 
    int intnr;
    WORD CLKDSPDIV;
    WORD CLKCR16DIV;
    int p, pp , pp_old;

    p = 0;

    /* Setup Linux IRQ handlers */
    dectIrqTestSetup();

    gprint("######## DECTIP_INT: Entry Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    SetWord(DEBUGGER_REG, 0xFFFF);
    SetWord (TEST_REG, DECTIP_INT);
    SetWord (CONFIG_REG, SetRdiMode);


    for(p=0;p<8;p++) {
     SetWord((SHARED_RAM_START+0x2FF0+(p*2)),0x0000);
    }


    gprint("######## DECTIP_INT: Load DM  Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    for(p=0;p<DM_size_int;p++) {
     SetWord((SHARED_RAM_START+((DM_addr_int[p])<<1)),DM_val_int[p]);
     if ((DM_addr_int[p]+1)<DM_addr_int[p+1] || p==DM_size_int-1) {
      SetWord((SHARED_RAM_START+((DM_addr_int[p])<<1)+2),0x0000);
      SetWord((SHARED_RAM_START+((DM_addr_int[p])<<1)+4),0x0000);
      SetWord((SHARED_RAM_START+((DM_addr_int[p])<<1)+6),0x0000);
     }
    }

    gprint("######## DECTIP_INT: Load PM  Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);

    for(p=0;p<PM_size_int;p++) {
     SetWord((SHARED_RAM_START+((PM_addr_int[p]-0x4000)<<1)),PM_val_int[p]);
     if ((PM_addr_int[p]+1)<PM_addr_int[p+1] || p==PM_size_int-1) {
      SetWord((SHARED_RAM_START+((PM_addr_int[p]-0x4000)<<1)+2),0x0000);
      SetWord((SHARED_RAM_START+((PM_addr_int[p]-0x4000)<<1)+4),0x0000);
      SetWord((SHARED_RAM_START+((PM_addr_int[p]-0x4000)<<1)+6),0x0000);
     }
    }

    gprint("######## DECTIP_INT: Setry entry points  Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    SetWord(DSP_PC_START_REG, DSP_PC_START_ADDRESS_int);
    SetWord(DSP_IRQ_START_REG,DSP_IRQ_START_ADDRESS_int);

    gprint("######## DECTIP_INT: Run test Status = 0x%x, Mask = 0x%x\n", *status, *mask, 0);
    Result = RunTest();

    /* Disable Linux IRQ handlers */
    dectIrqTestDisable();

    return Result;
}

    
