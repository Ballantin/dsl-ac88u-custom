# -*- tcl -*-

source test_procs.tcl

# This is used to filter certain strings out of the test output.
# The first text matching the regexp is replaced with 'repl'.

proc filterOut { filterRegExp repl } {
    global message

    regsub -line $filterRegExp $message $repl message
    return $message
}

############################################################################
# Tests 1.* - tunnel create parameters.
# Try to create a tunnel to 10.0.0.1 (which does not exist) while testing
# command parameters. Specify a src ipaddr to prevent the system deriving
# it via the system's route table (which will mess the test outputs up).
############################################################################

test tunnel-1.0 { Create tunnel w/ parameters... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.0
	l2tpConfig test modify no_random_ids=on reset_ids
	l2tpConfig system modify reset_statistics
	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble
    } \
    {

Modified test config
Modified system config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
}

test tunnel-1.1 { Create tunnel config_id= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.1

	l2tpConfig tunnel create tunnel_id=1 dest_ipaddr=10.0.0.1 config_id=1 src_ipaddr=127.0.0.1

	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel delete tunnel_id=1
    } \
    {

Created tunnel 1
Tunnel 1, from 127.0.0.1 to 10.0.0.1:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 1
}

test tunnel-1.2 { Create tunnel tunnel_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.2
	l2tpConfig tunnel create tunnel_id=2 config_id=2 dest_ipaddr=10.0.0.1 tunnel_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=2
	sleep 1
	addCrLf
    } \
    {

Created tunnel 2
Tunnel 2, from 127.0.0.1 to 10.0.0.1, config_id 2:-
  state: WAITCTLREPLY
  administrative name: 'wibble'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 2
}

test tunnel-1.3 { Show and delete tunnel by tunnel_name } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.3
	l2tpConfig tunnel create tunnel_id=3 config_id=3 dest_ipaddr=10.0.0.1 tunnel_name=weeble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_name=weeble config
	l2tpConfig tunnel delete tunnel_name=weeble
	sleep 1
	addCrLf
    } \
    {

Created tunnel 3
Tunnel 3, from 127.0.0.1 to 10.0.0.1, config_id 3:-
  state: WAITCTLREPLY
  administrative name: 'weeble'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel weeble
}

test tunnel-1.4 { Create tunnel profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.4
	l2tpConfig tunnel create tunnel_id=4 config_id=4 dest_ipaddr=10.0.0.1 profile_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=4 config
	l2tpConfig tunnel delete tunnel_id=4
	sleep 1
	addCrLf
    } \
    {

Created tunnel 4
Tunnel 4, from 127.0.0.1 to 10.0.0.1, config_id 4:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: wibble, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 4
}

test tunnel-1.5 { Create tunnel src_ipaddr= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.5
	l2tpConfig tunnel create tunnel_id=5 config_id=5 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=5 config
	l2tpConfig tunnel delete tunnel_id=5
	sleep 1
	addCrLf
    } \
    {

Created tunnel 5
Tunnel 5, from 127.0.0.1 to 10.0.0.1, config_id 5:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 5
}

test tunnel-1.6 { Create tunnel peer_udp_port= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.6
	l2tpConfig tunnel create tunnel_id=6 config_id=6 dest_ipaddr=10.0.0.1 peer_udp_port=5000 src_ipaddr=127.0.0.1 our_udp_port=1701
	l2tpConfig tunnel show tunnel_id=6 config
	l2tpConfig tunnel delete tunnel_id=6
	sleep 1
	addCrLf
    } \
    {

Created tunnel 6
Tunnel 6, from 127.0.0.1 to 10.0.0.1, config_id 6:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 1701, peer 5000
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 6
}

test tunnel-1.7 { Create tunnel use_tiebreaker= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.7
	l2tpConfig tunnel create tunnel_id=7 config_id=7 dest_ipaddr=10.0.0.1 use_tiebreaker=yes src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=7 config
	l2tpConfig tunnel delete tunnel_id=7
	sleep 1
	addCrLf
    } \
    {

Created tunnel 7
Tunnel 7, from 127.0.0.1 to 10.0.0.1, config_id 7:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: ON
  tiebreaker: 00 00 00 00 00 00 00 00
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 7
}

test tunnel-1.8 { Create tunnel allow_ppp_proxy= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.8
	l2tpConfig tunnel create tunnel_id=8 config_id=8 dest_ipaddr=10.0.0.1 allow_ppp_proxy=yes src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=8 config
	l2tpConfig tunnel delete tunnel_id=8
	sleep 1
	addCrLf
    } \
    {

Created tunnel 8
Tunnel 8, from 127.0.0.1 to 10.0.0.1, config_id 8:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: ON
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 8
}

test tunnel-1.9 { Create tunnel framing_caps= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.9
	l2tpConfig tunnel create tunnel_id=9 config_id=9 dest_ipaddr=10.0.0.1 framing_caps=sync src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=10 config_id=10 dest_ipaddr=10.0.0.2 framing_caps=async src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=11 config_id=11 dest_ipaddr=10.0.0.3 framing_caps=any src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=12 config_id=12 dest_ipaddr=10.0.0.4 framing_caps=none src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=9 config
	l2tpConfig tunnel show tunnel_id=10 config
	l2tpConfig tunnel show tunnel_id=11 config
	l2tpConfig tunnel show tunnel_id=12 config
	l2tpConfig tunnel delete tunnel_id=9
	l2tpConfig tunnel delete tunnel_id=10
	l2tpConfig tunnel delete tunnel_id=11
	l2tpConfig tunnel delete tunnel_id=12
	sleep 1
	addCrLf
    } \
    {

Created tunnel 9
Created tunnel 10
Created tunnel 11
Created tunnel 12
Tunnel 9, from 127.0.0.1 to 10.0.0.1, config_id 9:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 10, from 127.0.0.1 to 10.0.0.2, config_id 10:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 11, from 127.0.0.1 to 10.0.0.3, config_id 11:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 12, from 127.0.0.1 to 10.0.0.4, config_id 12:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: NONE, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 9
Deleted tunnel 10
Deleted tunnel 11
Deleted tunnel 12
}

test tunnel-1.10 { Create tunnel bearer_caps= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.10
	l2tpConfig tunnel create tunnel_id=13 config_id=13 dest_ipaddr=10.0.0.1 bearer_caps=digital src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=14 config_id=14 dest_ipaddr=10.0.0.2 bearer_caps=analog src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=15 config_id=15 dest_ipaddr=10.0.0.3 bearer_caps=any src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=16 config_id=16 dest_ipaddr=10.0.0.4 bearer_caps=none src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=13 config
	l2tpConfig tunnel show tunnel_id=14 config
	l2tpConfig tunnel show tunnel_id=15 config
	l2tpConfig tunnel show tunnel_id=16 config
	l2tpConfig tunnel delete tunnel_id=13
	l2tpConfig tunnel delete tunnel_id=14
	l2tpConfig tunnel delete tunnel_id=15
	l2tpConfig tunnel delete tunnel_id=16
	sleep 1
	addCrLf
    } \
    {

Created tunnel 13
Created tunnel 14
Created tunnel 15
Created tunnel 16
Tunnel 13, from 127.0.0.1 to 10.0.0.1, config_id 13:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 14, from 127.0.0.1 to 10.0.0.2, config_id 14:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 15, from 127.0.0.1 to 10.0.0.3, config_id 15:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 16, from 127.0.0.1 to 10.0.0.4, config_id 16:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: NONE
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 13
Deleted tunnel 14
Deleted tunnel 15
Deleted tunnel 16
}

test tunnel-1.11 { Create tunnel host_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.11
	l2tpConfig tunnel create tunnel_id=17 config_id=17 dest_ipaddr=10.0.0.1 host_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=17 config
	l2tpConfig tunnel delete tunnel_id=17
	sleep 1
	addCrLf
    } \
    {

Created tunnel 17
Tunnel 17, from 127.0.0.1 to 10.0.0.1, config_id 17:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  local host name: wibble
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 17
}

test tunnel-1.12 { Create tunnel secret= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.12
	l2tpConfig tunnel create tunnel_id=18 config_id=18 dest_ipaddr=10.0.0.1 secret=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=18 config
	l2tpConfig tunnel delete tunnel_id=18
	sleep 1
	addCrLf
    } \
    {

Created tunnel 18
Tunnel 18, from 127.0.0.1 to 10.0.0.1, config_id 18:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 18
}

test tunnel-1.13 { Create tunnel do_pmtu_discovery= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.13
	l2tpConfig tunnel create tunnel_id=19 config_id=19 dest_ipaddr=10.0.0.1 do_pmtu_discovery=yes src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=19 config
	l2tpConfig tunnel delete tunnel_id=19
	sleep 1
	addCrLf
    } \
    {

Created tunnel 19
Tunnel 19, from 127.0.0.1 to 10.0.0.1, config_id 19:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: ON, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 19
}

test tunnel-1.14 { Create tunnel mtu= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.14
	l2tpConfig tunnel create tunnel_id=20 config_id=20 dest_ipaddr=10.0.0.1 mtu=1400 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=20 config
	l2tpConfig tunnel delete tunnel_id=20
	sleep 1
	addCrLf
    } \
    {

Created tunnel 20
Tunnel 20, from 127.0.0.1 to 10.0.0.1, config_id 20:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 20
}

test tunnel-1.15 { Create tunnel trace_flags= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.15
	l2tpConfig tunnel create tunnel_id=21 config_id=21 dest_ipaddr=10.0.0.1 trace_flags=7 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=21 config
	l2tpConfig tunnel delete tunnel_id=21
	sleep 1
	addCrLf
    } \
    {

Created tunnel 21
Tunnel 21, from 127.0.0.1 to 10.0.0.1, config_id 21:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 21
}

test tunnel-1.16 { Create tunnel auth_mode= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.16
	l2tpConfig tunnel create tunnel_id=22 config_id=22 dest_ipaddr=10.0.0.1 auth_mode=none src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=23 config_id=23 dest_ipaddr=10.0.0.1 auth_mode=simple src_ipaddr=127.0.0.1
	l2tpConfig tunnel create tunnel_id=24 config_id=24 dest_ipaddr=10.0.0.1 auth_mode=challenge secret=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=22 config
	l2tpConfig tunnel show tunnel_id=23 config
	l2tpConfig tunnel show tunnel_id=24 config
	l2tpConfig tunnel delete tunnel_id=22
	l2tpConfig tunnel delete tunnel_id=23
	l2tpConfig tunnel delete tunnel_id=24
	sleep 1
	addCrLf
    } \
    {

Created tunnel 22
Created tunnel 23
Created tunnel 24
Tunnel 22, from 127.0.0.1 to 10.0.0.1, config_id 22:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 23, from 127.0.0.1 to 10.0.0.1, config_id 23:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: SIMPLE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 24, from 127.0.0.1 to 10.0.0.1, config_id 24:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 22
Deleted tunnel 23
Deleted tunnel 24
}

test tunnel-1.17 { Create tunnel hide_avps= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.17
	l2tpConfig tunnel create tunnel_id=25 config_id=25 dest_ipaddr=10.0.0.1 hide_avps=yes secret=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=25 config
	l2tpConfig tunnel delete tunnel_id=25
	sleep 1
	addCrLf
    } \
    {

Created tunnel 25
Tunnel 25, from 127.0.0.1 to 10.0.0.1, config_id 25:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: ON, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 25
}

test tunnel-1.18 { Create tunnel use_udp_checksums= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.18
	l2tpConfig tunnel create tunnel_id=26 config_id=26 dest_ipaddr=10.0.0.1 use_udp_checksums=no src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=26 config
	l2tpConfig tunnel delete tunnel_id=26
	sleep 1
	addCrLf
    } \
    {

Created tunnel 26
Tunnel 26, from 127.0.0.1 to 10.0.0.1, config_id 26:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 26
}

test tunnel-1.19 { Create tunnel hello_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.19
	l2tpConfig tunnel create tunnel_id=27 config_id=27 dest_ipaddr=10.0.0.1 hello_timeout=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=27 config
	l2tpConfig tunnel delete tunnel_id=27
	sleep 1
	addCrLf
    } \
    {

Created tunnel 27
Tunnel 27, from 127.0.0.1 to 10.0.0.1, config_id 27:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 42, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 27
}

test tunnel-1.20 { Create tunnel max_retries= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.20
	l2tpConfig tunnel create tunnel_id=28 config_id=28 dest_ipaddr=10.0.0.1 max_retries=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=28 config
	l2tpConfig tunnel delete tunnel_id=28
	sleep 1
	addCrLf
    } \
    {

Created tunnel 28
Tunnel 28, from 127.0.0.1 to 10.0.0.1, config_id 28:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 28
}

test tunnel-1.21 { Create tunnel rx_window_size= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.21
	l2tpConfig tunnel create tunnel_id=29 config_id=29 dest_ipaddr=10.0.0.1 rx_window_size=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=29 config
	l2tpConfig tunnel delete tunnel_id=29
	sleep 1
	addCrLf
    } \
    {

Created tunnel 29
Tunnel 29, from 127.0.0.1 to 10.0.0.1, config_id 29:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 42, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 29
}

test tunnel-1.22 { Create tunnel tx_window_size= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.22
	l2tpConfig tunnel create tunnel_id=30 config_id=30 dest_ipaddr=10.0.0.1 tx_window_size=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=30 config
	l2tpConfig tunnel delete tunnel_id=30
	sleep 1
	addCrLf
    } \
    {

Created tunnel 30
Tunnel 30, from 127.0.0.1 to 10.0.0.1, config_id 30:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 42, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 30
}

test tunnel-1.23 { Create tunnel retry_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.23
	l2tpConfig tunnel create tunnel_id=31 config_id=31 dest_ipaddr=10.0.0.1 retry_timeout=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=31 config
	l2tpConfig tunnel delete tunnel_id=31
	sleep 1
	addCrLf
    } \
    {

Created tunnel 31
Tunnel 31, from 127.0.0.1 to 10.0.0.1, config_id 31:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 42, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 31
}

test tunnel-1.24 { Create tunnel idle_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.24
	l2tpConfig tunnel create tunnel_id=32 config_id=32 dest_ipaddr=10.0.0.1 idle_timeout=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=32 config
	l2tpConfig tunnel delete tunnel_id=32
	sleep 1
	addCrLf
    } \
    {

Created tunnel 32
Tunnel 32, from 127.0.0.1 to 10.0.0.1, config_id 32:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 32
}

test tunnel-1.25 { Create tunnel max_sessions= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.25
	l2tpConfig tunnel create tunnel_id=33 config_id=33 dest_ipaddr=10.0.0.1 max_sessions=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=33 config
	l2tpConfig tunnel delete tunnel_id=33
	sleep 1
	addCrLf
    } \
    {

Created tunnel 33
Tunnel 33, from 127.0.0.1 to 10.0.0.1, config_id 33:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 33
}

test tunnel-1.26 { Create tunnel peer_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.26
	l2tpConfig tunnel create tunnel_id=34 config_id=34 dest_ipaddr=10.0.0.1 peer_profile_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=34 config
	l2tpConfig tunnel delete tunnel_id=34
	sleep 1
	addCrLf
    } \
    {

Created tunnel 34
Tunnel 34, from 127.0.0.1 to 10.0.0.1, config_id 34:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 34
}

test tunnel-1.27 { Create tunnel session_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.27
	l2tpConfig tunnel create tunnel_id=35 config_id=35 dest_ipaddr=10.0.0.1 session_profile_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=35 config
	l2tpConfig tunnel delete tunnel_id=35
	sleep 1
	addCrLf
    } \
    {

Created tunnel 35
Tunnel 35, from 127.0.0.1 to 10.0.0.1, config_id 35:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: wibble, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 35
}

test tunnel-1.28 { Create tunnel ppp_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.28
	l2tpConfig tunnel create tunnel_id=36 config_id=36 dest_ipaddr=10.0.0.1 ppp_profile_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=36 config
	l2tpConfig tunnel delete tunnel_id=36
	sleep 1
	addCrLf
    } \
    {

Created tunnel 36
Tunnel 36, from 127.0.0.1 to 10.0.0.1, config_id 36:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: wibble
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 36
}

test tunnel-1.29 { Create tunnel interface_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.29
	l2tpConfig tunnel create tunnel_id=37 config_id=37 dest_ipaddr=10.0.0.1 interface_name=wibble src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=37 config
	l2tpConfig tunnel delete tunnel_id=37
	sleep 1
	addCrLf
    } \
    {

Created tunnel 37
Tunnel 37, from 127.0.0.1 to 10.0.0.1, config_id 37:-
  state: WAITCTLREPLY
  interface name: wibble
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 37
}

test tunnel-1.30 { Create tunnel persist= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.30
	l2tpConfig tunnel create tunnel_id=38 config_id=38 dest_ipaddr=10.0.0.1 persist=yes src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=38 config
	l2tpConfig tunnel delete tunnel_id=38
	sleep 1
	addCrLf
    } \
    {

Created tunnel 38
Tunnel 38, from 127.0.0.1 to 10.0.0.1, config_id 38:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC, persist: YES
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 38
}

test tunnel-1.31 { Complex create tunnel with all args } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.31
	l2tpConfig tunnel create tunnel_id=39 config_id=39 dest_ipaddr=10.0.0.1 \
	  tunnel_name=complex \
	  profile_name=wibble \
	  interface_name=wibble \
	  persist=yes \
	  our_udp_port=1701 \
	  src_ipaddr=127.0.0.1 \
	  peer_udp_port=5000 \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  host_name=wibble \
	  secret=wibble \
	  hide_avps=yes \
	  use_tiebreaker=yes \
	  auth_mode=none \
	  allow_ppp_proxy=yes \
	  framing_caps=async \
	  bearer_caps=analog \
	  do_pmtu_discovery=yes \
	  mtu=1400 \
	  trace_flags=7 \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  rx_window_size=42 \
	  tx_window_size=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  max_sessions=42
	l2tpConfig tunnel show tunnel_id=39 config
	l2tpConfig tunnel delete tunnel_id=39
	sleep 1
	addCrLf
    } \
    {

Created tunnel 39
Tunnel 39, from 127.0.0.1 to 10.0.0.1, config_id 39:-
  state: WAITCTLREPLY
  administrative name: 'complex'
  interface name: wibble
  created by admin: YES, tunnel mode: LAC, persist: YES
  local host name: wibble
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 1701, peer 5000
  authorization mode: NONE, hide AVPs: ON, allow PPP proxy: ON
  tunnel secret: 'wibble'
  session limit: 42, session count: 0
  tunnel profile: wibble, peer profile: wibble
  session profile: wibble, ppp profile: wibble
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 42, tx window size: 42, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: ON, mtu: 1400
  framing capability: ASYNC, bearer capability: ANALOG
  use tiebreaker: ON
  tiebreaker: 00 00 00 00 00 00 00 00
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 39
}

test tunnel-1.99 { Tunnel create cleanup... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-1.99
	sleep 90
	l2tpConfig tunnel list
	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	addCrLf
    } \
    {


Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
Modified test config
Modified system config
}

############################################################################
# Tests 2.* - tunnel modify parameters
############################################################################

test tunnel-2.0 { Modify tunnel parameters... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.0
	l2tpConfig test modify no_random_ids=on reset_ids
	l2tpConfig system modify reset_statistics
	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble
	l2tpConfig tunnel create tunnel_id=42 dest_ipaddr=10.0.0.1 config_id=42 src_ipaddr=127.0.0.1
	l2tpConfig tunnel show tunnel_id=42 config
    } \
    {

Modified test config
Modified system config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.1 { Modify tunnel tunnel_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.1
	l2tpConfig tunnel modify tunnel_id=42 tunnel_name=wibble
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 tunnel_name=
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  administrative name: 'wibble'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.2 { Modify tunnel mtu= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.2
	l2tpConfig tunnel modify tunnel_id=42 mtu=1400
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 mtu=1460
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.3 { Modify tunnel trace_flags= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.3
	l2tpConfig tunnel modify tunnel_id=42 trace_flags=7
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 trace_flags=0xffffffff
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.5 { Modify tunnel use_udp_checksums= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.5
	l2tpConfig tunnel modify tunnel_id=42 use_udp_checksums=no
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 use_udp_checksums=yes
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.6 { Modify tunnel hello_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.6
	l2tpConfig tunnel modify tunnel_id=42 hello_timeout=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 hello_timeout=60
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 42, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.7 { Modify tunnel max_retries= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.7
	l2tpConfig tunnel modify tunnel_id=42 max_retries=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 max_retries=5
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.8 { Modify tunnel retry_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.8
	l2tpConfig tunnel modify tunnel_id=42 retry_timeout=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 retry_timeout=1
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 42, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.9 { Modify tunnel idle_timeout= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.9
	l2tpConfig tunnel modify tunnel_id=42 idle_timeout=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 idle_timeout=0
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.10 { Modify tunnel max_sessions= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.10
	l2tpConfig tunnel modify tunnel_id=42 max_sessions=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 max_sessions=0
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.11 { Modify tunnel peer_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.11
	l2tpConfig tunnel modify tunnel_id=42 peer_profile_name=wibble
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 peer_profile_name=default
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.12 { Modify tunnel session_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.12
	l2tpConfig tunnel modify tunnel_id=42 session_profile_name=wibble
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 session_profile_name=default
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: wibble, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.13 { Modify tunnel ppp_profile_name= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.13
	l2tpConfig tunnel modify tunnel_id=42 ppp_profile_name=wibble
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 ppp_profile_name=default
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: wibble
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.14 { Modify tunnel persist= } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.14
	l2tpConfig tunnel modify tunnel_id=42 persist=yes
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 persist=no
	l2tpConfig tunnel show tunnel_id=42 config
	addCrLf
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC, persist: YES
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
}

test tunnel-2.15 { Complex modify tunnel with all args } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.15
	l2tpConfig tunnel modify tunnel_id=42 \
	  tunnel_name=wibble \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  mtu=1400 \
	  trace_flags=7 \
	  persist=yes \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  max_sessions=42
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel modify tunnel_id=42 \
	  persist=no
    } \
    {

Modified tunnel 42
Tunnel 42, from 127.0.0.1 to 10.0.0.1, config_id 42:-
  state: WAITCTLREPLY
  administrative name: 'wibble'
  created by admin: YES, tunnel mode: LAC, persist: YES
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: wibble, ppp profile: wibble
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Modified tunnel 42
}

test tunnel-2.99 { Tunnel create cleanup... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-2.99
	l2tpConfig tunnel delete tunnel_id=42
	sleep 90
	l2tpConfig tunnel list
	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	addCrLf
    } \
    {

Deleted tunnel 42

Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
Modified test config
Modified system config
}

############################################################################
# Tests 4.* - tunnel profile parameter inheritance
############################################################################

test tunnel-4.0 { Setup tunnel profile parameter inheritance tests } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-4.0
	l2tpConfig test modify reset_ids
	l2tpConfig peer profile create profile_name=one \
	  tunnel_profile_name=one \
	  session_profile_name=one \
	  ppp_profile_name=one
	l2tpConfig tunnel profile create profile_name=one secret=wibble3
	l2tpConfig session profile create profile_name=one
	l2tpConfig ppp profile create profile_name=one
    } \
    {

Modified test config
Created peer profile one
Created tunnel profile one
Created session profile one
Created ppp profile one
}

test tunnel-4.1 { Tunnel profile parameter inheritance from default profile } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-4.1
	l2tpConfig test modify reset_ids

	l2tpConfig tunnel profile modify profile_name=default \
	  hello_timeout=42 \
	  max_retries=42 \
	  rx_window_size=42 \
	  tx_window_size=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  host_name=wibble2 \
	  secret=wibble3 \
	  hide_avps=yes \
	  use_tiebreaker=no \
	  allow_ppp_proxy=yes \
	  framing_caps=async \
	  bearer_caps=analog \
	  do_pmtu_discovery=no \
	  mtu=1400 \
	  trace_flags=15 \
	  auth_mode=none \
	  use_udp_checksums=off \
	  max_sessions=42 \
	  peer_profile_name=one \
	  session_profile_name=one \
	  ppp_profile_name=one

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel show tunnel_id=1 config

	# Put the default profile back for subsequent tests.
	# Workaround CLI "empty string arg" parser bug by putting
	# all the empty string assignments at the end.
	l2tpConfig tunnel profile modify profile_name=default \
	  hello_timeout=60 \
	  max_retries=5 \
	  rx_window_size=10 \
	  tx_window_size=10 \
	  retry_timeout=1 \
	  idle_timeout=0 \
	  hide_avps=no \
	  use_tiebreaker=no \
	  allow_ppp_proxy=no \
	  framing_caps=any \
	  bearer_caps=any \
	  do_pmtu_discovery=no \
	  mtu=1460 \
	  trace_flags=0xffffffff \
	  auth_mode=none \
	  use_udp_checksums=yes \
	  max_sessions=0 \
	  peer_profile_name=default \
	  session_profile_name=default \
	  ppp_profile_name=default
	l2tpConfig tunnel profile modify profile_name=default \
	  host_name=
	l2tpConfig tunnel profile modify profile_name=default \
	  secret=

	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified tunnel profile default
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: ON, allow PPP proxy: ON
  tunnel secret: 'wibble3'
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: default
  session profile: one, ppp profile: one
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 42, tx window size: 42, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: ASYNC, bearer capability: ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
  negotiated tx window size: 10
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 42, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble3'
  session limit: 0, session count: 0
  tunnel profile: one, peer profile: one
  session profile: one, ppp profile: one
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: ASYNC
  peer bearer capability: ANALOG
  peer rx window size: 42
Modified tunnel profile default
Modified tunnel profile default
Modified tunnel profile default
Deleted tunnel 1

}

test tunnel-4.2 { Tunnel profile parameter inheritance from non-default profile } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-4.2
	l2tpConfig test modify reset_ids

	l2tpConfig tunnel profile modify profile_name=one \
	  hello_timeout=42 \
	  max_retries=42 \
	  rx_window_size=42 \
	  tx_window_size=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  host_name=wibble2 \
	  secret=wibble3 \
	  hide_avps=no \
	  use_tiebreaker=no \
	  allow_ppp_proxy=yes \
	  framing_caps=async \
	  bearer_caps=analog \
	  do_pmtu_discovery=no \
	  mtu=1400 \
	  trace_flags=15 \
	  auth_mode=none \
	  use_udp_checksums=off \
	  max_sessions=42 \
	  peer_profile_name=one \
	  session_profile_name=one \
	  ppp_profile_name=one

	# Remote tunnel should use tunnel profile 'one' because it is referenced by peer profile 'one'
	# via host_name=one

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 profile_name=one host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel show tunnel_id=1 config

	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified tunnel profile one
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: ON
  tunnel secret: 'wibble3'
  session limit: 42, session count: 0
  tunnel profile: one, peer profile: default
  session profile: one, ppp profile: one
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 42, tx window size: 42, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: ASYNC, bearer capability: ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: ASYNC
  peer bearer capability: ANALOG
  peer rx window size: 42
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  local host name: wibble2
  peer tunnel id: 42, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: ON
  tunnel secret: 'wibble3'
  session limit: 42, session count: 0
  tunnel profile: one, peer profile: one
  session profile: one, ppp profile: one
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 42, tx window size: 42, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: ASYNC, bearer capability: ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: ASYNC
  peer bearer capability: ANALOG
  peer rx window size: 42
Deleted tunnel 1

}

test tunnel-4.99 { Cleanup tunnel profile parameter inheritance tests } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-4.99
	l2tpConfig peer profile delete profile_name=one
	l2tpConfig tunnel profile delete profile_name=one
	l2tpConfig session profile delete profile_name=one
	l2tpConfig ppp profile delete profile_name=one
    } \
    {

Deleted peer profile one
Deleted tunnel profile one
Deleted session profile one
Deleted ppp profile one
}

############################################################################
# Tests 5.* - basic tunnel operations (loopback)
############################################################################

test tunnel-5.0 { Create loopback tunnels... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.0
	l2tpConfig test modify no_random_ids=on reset_ids
	l2tpConfig system modify reset_statistics
    } \
    {

Modified test config
Modified system config
}

# Test all tunnel display attributes.
# Since we check transport stats here, we must set the host_name to a 
# constant value, otherwise the number of bytes transmitted will differ
# when the test is run on different machines...
test tunnel-5.1 { Create a loopback tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.1
	l2tpConfig tunnel profile modify profile_name=default host_name=wobble
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 host_name=wibble
	sleep 1
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig tunnel show tunnel_id=1
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=1 transport
	l2tpConfig tunnel show tunnel_id=2
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel show tunnel_id=2 transport
	l2tpConfig tunnel profile modify profile_name=default host_name=
    } \
    {

Modified tunnel profile default
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
L2TP counters:-
  Total messages sent: 3, received: 3, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                1                0                1
           SCCCN                1                0                1
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: wibble
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
  Transport status:-
    ns/nr: 2/1, peer 2/1
    cwnd: 3, ssthresh: 10, congpkt_acc: 0
  Transport statistics:-
    out-of-sequence control/data discards: 0/0
    zlbs tx/txfail/rx: 1/0/1
    retransmits: 0, duplicate pkt discards: 0, data pkt discards: 0
    hellos tx/txfail/rx: 0/0/0
    control rx packets: 2, rx bytes: 128
    control tx packets: 3, tx bytes: 148
    data rx packets: 0, rx bytes: 0, rx errors: 0
    data tx packets: 0, tx bytes: 0, tx errors: 0
    establish retries: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: wibble
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  Transport status:-
    ns/nr: 2/1, peer 2/1
    cwnd: 3, ssthresh: 10, congpkt_acc: 0
  Transport statistics:-
    out-of-sequence control/data discards: 0/0
    zlbs tx/txfail/rx: 1/0/1
    retransmits: 0, duplicate pkt discards: 0, data pkt discards: 0
    hellos tx/txfail/rx: 0/0/0
    control rx packets: 2, rx bytes: 128
    control tx packets: 3, tx bytes: 148
    data rx packets: 0, rx bytes: 0, rx errors: 0
    data tx packets: 0, tx bytes: 0, tx errors: 0
    establish retries: 0
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  local host name: wobble
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
  Transport status:-
    ns/nr: 1/2, peer 1/2
    cwnd: 2, ssthresh: 10, congpkt_acc: 0
  Transport statistics:-
    out-of-sequence control/data discards: 0/0
    zlbs tx/txfail/rx: 1/0/1
    retransmits: 0, duplicate pkt discards: 0, data pkt discards: 0
    hellos tx/txfail/rx: 0/0/0
    control rx packets: 3, rx bytes: 148
    control tx packets: 2, tx bytes: 128
    data rx packets: 0, rx bytes: 0, rx errors: 0
    data tx packets: 0, tx bytes: 0, tx errors: 0
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  local host name: wobble
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  Transport status:-
    ns/nr: 1/2, peer 1/2
    cwnd: 2, ssthresh: 10, congpkt_acc: 0
  Transport statistics:-
    out-of-sequence control/data discards: 0/0
    zlbs tx/txfail/rx: 1/0/1
    retransmits: 0, duplicate pkt discards: 0, data pkt discards: 0
    hellos tx/txfail/rx: 0/0/0
    control rx packets: 3, rx bytes: 148
    control tx packets: 2, tx bytes: 128
    data rx packets: 0, rx bytes: 0, rx errors: 0
    data tx packets: 0, tx bytes: 0, tx errors: 0
Modified tunnel profile default
}

test tunnel-5.2 { Hello timer } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.2
	sleep 70
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
    } \
    {

L2TP service status:-
  tunnels: 2, sessions: 0
L2TP counters:-
  Total messages sent: 4, received: 4, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                1                0                1
           SCCCN                1                0                1
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                1                0                1
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: wibble
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  local host name: wobble
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
}

test tunnel-5.3 { Delete tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.3
	l2tpConfig tunnel delete tunnel_id=1
	l2tpConfig tunnel list
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
    } \
    {

Deleted tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1          CLOSING
*      2        127.0.0.1        127.0.0.1        1        2          CLOSING

L2TP service status:-
  tunnels: 0, sessions: 0
L2TP counters:-
  Total messages sent: 5, received: 5, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                1                0                1
           SCCCN                1                0                1
         STOPCCN                1                0                1
       RESERVED1                0                0                0
           HELLO                1                0                1
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
}

test tunnel-5.4 { Reset message statistics } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.4
	l2tpConfig system modify reset_statistics
	l2tpConfig system show statistics
    } \
    {

Modified system config
L2TP counters:-
  Total messages sent: 0, received: 0, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                0                0                0
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
}

test tunnel-5.5 { Create a loopback tunnel with local hello messages turned off } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.5
	l2tpConfig system modify reset_statistics
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 hello_timeout=0
	sleep 1
	l2tpConfig tunnel list
	sleep 70
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig tunnel show tunnel_id=1 config
    } \
    {

Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
L2TP counters:-
  Total messages sent: 4, received: 4, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                1                0                1
           SCCCN                1                0                1
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                1                0                1
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 3, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 0, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
}

test tunnel-5.6 { Modify hello_timeout of remote tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.6
	l2tpConfig system modify reset_statistics
	l2tpConfig tunnel list
	l2tpConfig tunnel show tunnel_id=3 config
	sleep 62
	l2tpConfig system show statistics
	l2tpConfig tunnel modify tunnel_id=3 hello_timeout=0
	l2tpConfig tunnel show tunnel_id=3 config
	sleep 62
	l2tpConfig system show statistics
    } \
    {

Modified system config
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Tunnel 3, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
L2TP counters:-
  Total messages sent: 1, received: 1, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                0                0                0
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                1                0                1
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Modified tunnel 3
Tunnel 3, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 0, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
L2TP counters:-
  Total messages sent: 1, received: 1, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                0                0                0
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                1                0                1
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
}

test tunnel-5.7 { Delete remote (network-created) side of tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.7
	l2tpConfig system modify reset_statistics
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=3
	l2tpConfig tunnel list
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	addCrLf
    } \
    {

Modified system config
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 3
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1          CLOSING
*      3        127.0.0.1        127.0.0.1        1        2          CLOSING

L2TP service status:-
  tunnels: 0, sessions: 0
}

test tunnel-5.8 { Tunnel create with AVP hiding enabled at requestor } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.8
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	l2tpConfig tunnel profile modify profile_name=default secret=wibble
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 secret=wibble hide_avps=yes
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 70
	l2tpConfig tunnel profile modify profile_name=default secret=
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Modified tunnel profile default
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: ON, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified tunnel profile default

}

test tunnel-5.9 { Tunnel create with challenge authentication } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.9
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	sleep 1
	l2tpConfig tunnel profile modify profile_name=default secret=wibble
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 secret=wibble auth_mode=challenge
	sleep 2
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel profile modify profile_name=default secret=
    } \
    {

Modified test config
Modified system config
Modified tunnel profile default
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified tunnel profile default
}

test tunnel-5.10 { Tunnel tx_window_size negotiation } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.10
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	sleep 1
	l2tpConfig tunnel profile modify profile_name=default rx_window_size=6
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 tx_window_size=8 rx_window_size=10
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 tx_window_size=4 rx_window_size=10
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel profile modify profile_name=default rx_window_size=10
    } \
    {

Modified test config
Modified system config
Modified tunnel profile default
Created tunnel 1
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 8, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 6
  negotiated tx window size: 6
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 6, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified test config
Created tunnel 1
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 4, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 6
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 6, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified tunnel profile default
}

test tunnel-5.11 { Tunnel local UDP port assignment at remote } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.11
	l2tpConfig test modify no_random_ids=off reset_ids
	l2tpConfig system modify reset_statistics
	sleep 1
	l2tpConfig tunnel profile create profile_name=one
	l2tpConfig tunnel profile modify profile_name=default our_udp_port=5000
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 profile_name=one
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel delete tunnel_id=1
	l2tpConfig tunnel profile modify profile_name=default our_udp_port=0
	l2tpConfig tunnel profile delete profile_name=one
	filterOut "  created at: .*" "  created at:"
	filterOut "  peer tunnel id: .*," "  peer tunnel_id: 0,"
	filterOut "  UDP ports: local .*," "  UDP ports: local 0,"
	sleep 5
	addCrLf
    } \
    {

Modified test config
Modified system config
Created tunnel profile one
Modified tunnel profile default
Created tunnel 1
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created at:
  created by admin: YES, tunnel mode: LAC
  peer tunnel_id: 0, host name: NOT SET
  UDP ports: local 0, peer 5000
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: one, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified tunnel profile default
Deleted tunnel profile one
}

test tunnel-5.12 { Tunnel local UDP port assignment at local side } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.12
	l2tpConfig test modify no_random_ids=off reset_ids
	l2tpConfig system modify reset_statistics
	sleep 1
	l2tpConfig tunnel profile modify profile_name=default our_udp_port=5000
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel delete tunnel_id=1
	l2tpConfig tunnel profile modify profile_name=default our_udp_port=0
	filterOut "  created at: .*" "  created at:"
	filterOut "  peer tunnel id: .*," "  peer tunnel_id: 0,"
	filterOut ", peer .*" ", peer 0"
	sleep 5
	addCrLf
    } \
    {

Modified test config
Modified system config
Modified tunnel profile default
Created tunnel 1
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created at:
  created by admin: YES, tunnel mode: LAC
  peer tunnel_id: 0, host name: NOT SET
  UDP ports: local 5000, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Modified tunnel profile default
}

test tunnel-5.13 { Tunnel src ip address assignment at local side } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.13
	l2tpConfig test modify no_random_ids=off reset_ids
	l2tpConfig system modify reset_statistics
	sleep 1
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 src_ipaddr=192.168.0.1
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel delete tunnel_id=1
	filterOut "  created at: .*" "  created at:"
	filterOut "  peer tunnel id: .*," "  peer tunnel_id: 0,"
	filterOut "  UDP ports: local .*," "  UDP ports: local 0,"
	filterOut ", peer .*" ", peer 0"
	sleep 5
	addCrLf
    } \
    {

Modified test config
Modified system config
Created tunnel 1
Tunnel 1, from 192.168.0.1 to 192.168.0.1:-
  state: ESTABLISHED
  created at:
  created by admin: YES, tunnel mode: LAC
  peer tunnel_id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
}

test tunnel-5.14 { Persistent tunnel recreates itself if remote closes } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.14
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig system modify reset_statistics tunnel_persist_pend_timeout=120
	sleep 1
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 persist=yes
	sleep 2
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=2
	sleep 5
	l2tpConfig tunnel list
	sleep 120
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system modify tunnel_persist_pend_timeout=120
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC, persist: YES
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 2
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1            RETRY
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 1

Modified system config
}

test tunnel-5.15 { Persistent tunnel recreates itself network fails  } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.15
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig system modify reset_statistics tunnel_persist_pend_timeout=120
	sleep 1
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 persist=yes
	sleep 2
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig test modify fake_rx_drop=yes fake_tx_drop=yes fake_trigger_type=on
	# wait for tunnels to fail
	sleep 90
	l2tpConfig tunnel list
	l2tpConfig test modify fake_rx_drop=no fake_tx_drop=no fake_trigger_type=off
	# wait for persist_pending timeout
	sleep 180
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system modify tunnel_persist_pend_timeout=120
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC, persist: YES
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Modified test config
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1            RETRY
*      2        127.0.0.1        127.0.0.1        1        2          CLOSING
Modified test config
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        3        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 1

Modified system config
}

test tunnel-5.16 { Tunnel without sessions does not close if idle_timeout expires } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-5.16
	l2tpConfig test modify reset_ids no_random_ids=on
	sleep 1
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 config_id=1 idle_timeout=10
	sleep 2
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	# wait for idle_timeout to expire
	sleep 20
	# check tunnel still up
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
L2TP service status:-
  tunnels: 2, sessions: 0
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 10
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 1

}

############################################################################
# Tests 6.*
# Tunnel creation denial by admin or by limits
############################################################################

test tunnel-6.0 { Tunnel creation failure test setup... } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-6.0
	l2tpConfig test modify no_random_ids=on reset_ids
	l2tpConfig system modify reset_statistics
    } \
    {

Modified test config
Modified system config
}

test tunnel-6.1 { Tunnel creation rejected by local config } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-6.1
	l2tpConfig system modify deny_local_tunnel_creates=yes
	l2tpConfig tunnel create tunnel_id=1 dest_ipaddr=127.0.0.1 config_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig system modify deny_local_tunnel_creates=no
    } \
    {

Modified system config
Error at or near 'create'
Operation failed: Tunnel creation is administratively disabled

L2TP service status:-
  tunnels: 0, sessions: 0
L2TP counters:-
  Total messages sent: 0, received: 0, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                0                0                0
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Modified system config
}

test tunnel-6.2 { Tunnel creation rejected by remote config } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-6.2
	l2tpConfig system modify deny_remote_tunnel_creates=yes
	l2tpConfig tunnel create tunnel_id=2 dest_ipaddr=127.0.0.1 config_id=2
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig system modify deny_remote_tunnel_creates=no
    } \
    {

Modified system config
Created tunnel 2

L2TP service status:-
  tunnels: 0, sessions: 0
L2TP counters:-
  Total messages sent: 2, received: 2, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 1, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                1                0                1
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Modified system config
}

test tunnel-6.3 { Tunnel creation rejected by "drain tunnels" } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-6.3
	l2tpConfig system modify drain_tunnels=yes reset_statistics
	l2tpConfig tunnel create tunnel_id=3 dest_ipaddr=127.0.0.1 config_id=3
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig system modify drain_tunnels=no
	addCrLf
    } \
    {

Modified system config
Error at or near 'create'
Operation failed: Tunnel creation is administratively disabled

L2TP service status:-
  tunnels: 0, sessions: 0
L2TP counters:-
  Total messages sent: 0, received: 0, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                0                0                0
           SCCRP                0                0                0
           SCCCN                0                0                0
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Modified system config
}

test tunnel-6.4 { Tunnel creation rejected by tunnel limit } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-6.4
	l2tpConfig system modify reset_statistics
	l2tpConfig system modify max_tunnels=6
	l2tpConfig tunnel create tunnel_id=50 dest_ipaddr=127.0.0.1 config_id=50
	l2tpConfig tunnel create tunnel_id=51 dest_ipaddr=127.0.0.1 config_id=51
	l2tpConfig tunnel create tunnel_id=52 dest_ipaddr=127.0.0.1 config_id=52
	l2tpConfig tunnel create tunnel_id=53 dest_ipaddr=127.0.0.1 config_id=53
	sleep 10
	l2tpConfig tunnel list
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig tunnel delete tunnel_id=51
	l2tpConfig tunnel delete tunnel_id=52
	l2tpConfig system modify max_tunnels=0
	sleep 10
	addCrLf
    } \
    {

Modified system config
Modified system config
Created tunnel 50
Created tunnel 51
Created tunnel 52
Error at or near 'create'
Operation failed: Tunnel limit exceeded
   TunId             Peer            Local  PeerTId ConfigId            State
*      2        127.0.0.1        127.0.0.1       50        1      ESTABLISHED
*      3        127.0.0.1        127.0.0.1       51        2      ESTABLISHED
*      4        127.0.0.1        127.0.0.1       52        3      ESTABLISHED
      50        127.0.0.1        127.0.0.1        2       50      ESTABLISHED
      51        127.0.0.1        127.0.0.1        3       51      ESTABLISHED
      52        127.0.0.1        127.0.0.1        4       52      ESTABLISHED
L2TP service status:-
  tunnels: 6, sessions: 0
L2TP counters:-
  Total messages sent: 9, received: 9, retransmitted: 0
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 1, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                3                0                3
           SCCRP                3                0                3
           SCCCN                3                0                3
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0
Deleted tunnel 50
Deleted tunnel 51
Deleted tunnel 52
Modified system config
}

############################################################################
# Tests 7.* - peer profile derivation for incoming tunnel requests
############################################################################

test tunnel-7.0 { Setup peer profile derivation tests } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-7.0
	l2tpConfig test modify no_random_ids=on reset_ids
	l2tpConfig system modify reset_statistics
	l2tpConfig peer profile create profile_name=pp_one tunnel_profile_name=tp_one
	l2tpConfig peer profile create profile_name=pp_two tunnel_profile_name=tp_two
	l2tpConfig tunnel profile create profile_name=tp_one max_sessions=42
	l2tpConfig tunnel profile create profile_name=tp_two max_sessions=43
    } \
    {

Modified test config
Modified system config
Created peer profile pp_one
Created peer profile pp_two
Created tunnel profile tp_one
Created tunnel profile tp_two
}

test tunnel-7.1 { Derive peer profile from host_name AVP } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-7.1
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create tunnel_id=1 config_id=1 dest_ipaddr=127.0.0.1 host_name=pp_one
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	addCrLf
    } \
    {

Modified test config
Created tunnel 1
Tunnel 1, from 127.0.0.1 to 127.0.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: pp_one
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 127.0.0.1 to 127.0.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 42, session count: 0
  tunnel profile: tp_one, peer profile: pp_one
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
}

test tunnel-7.2 { Derive peer profile from src IP } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-7.2
	l2tpConfig test modify reset_ids
	set sysIpAddr [getSysIpAddr]
	if { [string compare $sysIpAddr ""] == 0 } {
	    puts stderr "Can't derive system's eth0 IP address"
	    exit 1
	}
	l2tpConfig peer profile create profile_name=pp_three peer_ipaddr=$sysIpAddr tunnel_profile_name=tp_two
	l2tpConfig tunnel create tunnel_id=1 config_id=1 dest_ipaddr=$sysIpAddr
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig peer profile delete profile_name=pp_three
    } \
    {

Modified test config
Created peer profile pp_three
Created tunnel 1
Tunnel 1, from 192.168.0.1 to 192.168.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 192.168.0.1 to 192.168.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 43, session count: 0
  tunnel profile: tp_two, peer profile: pp_three
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1
Deleted peer profile pp_three
}

test tunnel-7.3 { Derive peer profile from src IP w/ netmask } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-7.3
	l2tpConfig test modify reset_ids
	set sysIpAddr [getSysIpAddr]
	if { [string compare $sysIpAddr ""] == 0 } {
	    puts stderr "Can't derive system's eth0 IP address"
	    exit 1
	}
	set sysNet0 [lindex [split $sysIpAddr .] 0]
	set sysNet1 [lindex [split $sysIpAddr .] 1]
	l2tpConfig peer profile create profile_name=pp_three peer_ipaddr=$sysNet0.42.43.44 netmask=255.0.0.0 tunnel_profile_name=tp_one
	l2tpConfig peer profile create profile_name=pp_four peer_ipaddr=$sysNet0.$sysNet1.43.44 netmask=255.255.0.0 tunnel_profile_name=tp_two
	l2tpConfig tunnel create tunnel_id=1 config_id=1 dest_ipaddr=$sysIpAddr
	sleep 2
	l2tpConfig tunnel show tunnel_id=1 config
	l2tpConfig tunnel show tunnel_id=2 config
	l2tpConfig tunnel delete tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig peer profile delete profile_name=pp_three
	l2tpConfig peer profile delete profile_name=pp_four
    } \
    {

Modified test config
Created peer profile pp_three
Created peer profile pp_four
Created tunnel 1
Tunnel 1, from 192.168.0.1 to 192.168.0.1:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 2, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Tunnel 2, from 192.168.0.1 to 192.168.0.1, config_id 2:-
  state: ESTABLISHED
  created by admin: NO, tunnel mode: LNS
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 43, session count: 0
  tunnel profile: tp_two, peer profile: pp_four
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
Deleted tunnel 1

Deleted peer profile pp_three
Deleted peer profile pp_four
}

test tunnel-7.99 { Cleanup peer profile derivation tests } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig tunnel profile delete profile_name=tp_one
	l2tpConfig tunnel profile delete profile_name=tp_two
	l2tpConfig peer profile delete profile_name=pp_one
	l2tpConfig peer profile delete profile_name=pp_two
    } \
    {
Deleted tunnel profile tp_one
Deleted tunnel profile tp_two
Deleted peer profile pp_one
Deleted peer profile pp_two
}

############################################################################
# Tests 8.*
# Tunnel authentication
############################################################################

test tunnel-8.0 { Tunnel authentication setup } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.0
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics
	l2tpConfig tunnel list
	l2tpConfig peer profile create profile_name=one tunnel_profile_name=one
	l2tpConfig tunnel profile create profile_name=one secret=wibble host_name=one
	l2tpConfig tunnel profile create profile_name=two secret=wobble host_name=two
    } \
    {

Modified test config
Modified system config

Created peer profile one
Created tunnel profile one
Created tunnel profile two
}

# Simple mode - matching peer profile must exist at remote

test tunnel-8.1 { Tunnel authentication success: simple mode } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.1
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  auth_mode=simple host_name=one
	sleep 2
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=42
	sleep 62
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1      ESTABLISHED
      42        127.0.0.1        127.0.0.1        1       42      ESTABLISHED
Deleted tunnel 42

}

test tunnel-8.2 { Tunnel authentication failure: simple mode } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.2
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  auth_mode=simple host_name=two
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: CLOSING
  created by admin: YES, tunnel mode: LAC
  local host name: two
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: SIMPLE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  local error information:-
    result code: 4, error code: 0
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1          CLOSING
      42        127.0.0.1        127.0.0.1        1       42          CLOSING

}

test tunnel-8.3 { Tunnel authentication success: challenge mode } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.3
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  secret=wibble auth_mode=challenge host_name=one
	sleep 2
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=42
	sleep 62
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1      ESTABLISHED
      42        127.0.0.1        127.0.0.1        1       42      ESTABLISHED
Deleted tunnel 42

}

test tunnel-8.4 { Tunnel authentication failure: challenge mode incorrect password } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.4
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  secret=weeble auth_mode=challenge host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: CLOSING
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'weeble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  local error information:-
    result code: 4, error code: 0
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1          CLOSING
      42        127.0.0.1        127.0.0.1        1       42          CLOSING

}

test tunnel-8.5 { Tunnel authentication success: locally forced challenge } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.5
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  secret=wibble auth_mode=challenge host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=42
	sleep 62
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: ESTABLISHED
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1      ESTABLISHED
      42        127.0.0.1        127.0.0.1        1       42      ESTABLISHED
Deleted tunnel 42

}

test tunnel-8.6 { Tunnel authentication failure: locally forced challenge w/ incorrect password } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.5
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  secret=weeble auth_mode=challenge host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: CLOSING
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 1, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'weeble'
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  local error information:-
    result code: 4, error code: 0
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer vendor name: Katalix Systems Ltd. Linux
  peer protocol version: 1.0, firmware 262
  peer framing capability: SYNC ASYNC
  peer bearer capability: DIGITAL ANALOG
  peer rx window size: 10
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1       42        1          CLOSING
      42        127.0.0.1        127.0.0.1        1       42          CLOSING

}

test tunnel-8.7 { Tunnel authentication failure: locally forced challenge w/ no password } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.7
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=42 config_id=42 \
	  auth_mode=challenge host_name=one
	sleep 1
	l2tpConfig tunnel show tunnel_id=42 config
	l2tpConfig tunnel list
	sleep 65
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 42
Tunnel 42, from 127.0.0.1 to 127.0.0.1, config_id 42:-
  state: CLOSING
  created by admin: YES, tunnel mode: LAC
  local host name: one
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: CHALLENGE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  local error information:-
    result code: 4, error code: 0
    error message: no tunnel secret available
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
   TunId             Peer            Local  PeerTId ConfigId            State
      42        127.0.0.1        127.0.0.1        0       42          CLOSING

}

test tunnel-8.99 { Tunnel authentication cleanup } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-8.99
	l2tpConfig test modify reset_ids
	l2tpConfig tunnel profile delete profile_name=one
	l2tpConfig tunnel profile delete profile_name=two
	l2tpConfig peer profile delete profile_name=one
    } \
    {

Modified test config
Deleted tunnel profile one
Deleted tunnel profile two
Deleted peer profile one
}

############################################################################
# Tests 9.*
# Stress tests
############################################################################

test tunnel-9.1 { Send many control messages (HELLOs) in one direction } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-9.1
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1
	sleep 2
	l2tpConfig tunnel list

	# Built-in test sends 100 HELLOs out the specified tunnel
	l2tpConfig test modify do_transport_test tunnel_id=1

	sleep 70
	l2tpConfig system show status
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=1
	sleep 62
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
L2TP service status:-
  tunnels: 2, sessions: 0
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 1

}

test tunnel-9.2 { Send many control messages (HELLOs) in both directions } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-9.2
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1
	sleep 2
	l2tpConfig tunnel list

	# Built-in test sends 100 HELLOs out the specified tunnels
	l2tpConfig test modify do_transport_test tunnel_id=1
	l2tpConfig test modify do_transport_test tunnel_id=2

	sleep 124
	l2tpConfig system show status
	l2tpConfig tunnel list
	l2tpConfig tunnel delete tunnel_id=1
	sleep 62
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
Modified test config
L2TP service status:-
  tunnels: 2, sessions: 0
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel 1

}

test tunnel-9.3 { Create/delete many loopback tunnels } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-9.3
	l2tpConfig test modify reset_ids
	l2tpConfig system modify reset_statistics

	# Stay under default system tunnel limit of 100. 
	# Since we're creating tunnels to ourself, we create 2 tunnels per request...
	for { set i 0 } { $i < 49 } { incr i } {
	    l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=[expr ($i + 100)]
	}
	sleep 124
	l2tpConfig system show status
	l2tpConfig tunnel list
	for { set i 0 } { $i < 49 } { incr i } {
	    l2tpConfig tunnel delete tunnel_id=[expr ($i + 100)]
	}
	sleep 124
	l2tpConfig system show status
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Created tunnel 100
Created tunnel 101
Created tunnel 102
Created tunnel 103
Created tunnel 104
Created tunnel 105
Created tunnel 106
Created tunnel 107
Created tunnel 108
Created tunnel 109
Created tunnel 110
Created tunnel 111
Created tunnel 112
Created tunnel 113
Created tunnel 114
Created tunnel 115
Created tunnel 116
Created tunnel 117
Created tunnel 118
Created tunnel 119
Created tunnel 120
Created tunnel 121
Created tunnel 122
Created tunnel 123
Created tunnel 124
Created tunnel 125
Created tunnel 126
Created tunnel 127
Created tunnel 128
Created tunnel 129
Created tunnel 130
Created tunnel 131
Created tunnel 132
Created tunnel 133
Created tunnel 134
Created tunnel 135
Created tunnel 136
Created tunnel 137
Created tunnel 138
Created tunnel 139
Created tunnel 140
Created tunnel 141
Created tunnel 142
Created tunnel 143
Created tunnel 144
Created tunnel 145
Created tunnel 146
Created tunnel 147
Created tunnel 148
L2TP service status:-
  tunnels: 98, sessions: 0
   TunId             Peer            Local  PeerTId ConfigId            State
*      1        127.0.0.1        127.0.0.1      100        2      ESTABLISHED
*      2        127.0.0.1        127.0.0.1      101        4      ESTABLISHED
*      3        127.0.0.1        127.0.0.1      102        6      ESTABLISHED
*      4        127.0.0.1        127.0.0.1      103        8      ESTABLISHED
*      5        127.0.0.1        127.0.0.1      104       10      ESTABLISHED
*      6        127.0.0.1        127.0.0.1      105       12      ESTABLISHED
*      7        127.0.0.1        127.0.0.1      106       14      ESTABLISHED
*      8        127.0.0.1        127.0.0.1      107       16      ESTABLISHED
*      9        127.0.0.1        127.0.0.1      108       18      ESTABLISHED
*     10        127.0.0.1        127.0.0.1      109       20      ESTABLISHED
*     11        127.0.0.1        127.0.0.1      110       22      ESTABLISHED
*     12        127.0.0.1        127.0.0.1      111       24      ESTABLISHED
*     13        127.0.0.1        127.0.0.1      112       26      ESTABLISHED
*     14        127.0.0.1        127.0.0.1      113       28      ESTABLISHED
*     15        127.0.0.1        127.0.0.1      114       30      ESTABLISHED
*     16        127.0.0.1        127.0.0.1      115       32      ESTABLISHED
*     17        127.0.0.1        127.0.0.1      116       34      ESTABLISHED
*     18        127.0.0.1        127.0.0.1      117       36      ESTABLISHED
*     19        127.0.0.1        127.0.0.1      118       38      ESTABLISHED
*     20        127.0.0.1        127.0.0.1      119       40      ESTABLISHED
*     21        127.0.0.1        127.0.0.1      120       42      ESTABLISHED
*     22        127.0.0.1        127.0.0.1      121       44      ESTABLISHED
*     23        127.0.0.1        127.0.0.1      122       46      ESTABLISHED
*     24        127.0.0.1        127.0.0.1      123       48      ESTABLISHED
*     25        127.0.0.1        127.0.0.1      124       50      ESTABLISHED
*     26        127.0.0.1        127.0.0.1      125       52      ESTABLISHED
*     27        127.0.0.1        127.0.0.1      126       54      ESTABLISHED
*     28        127.0.0.1        127.0.0.1      127       56      ESTABLISHED
*     29        127.0.0.1        127.0.0.1      128       58      ESTABLISHED
*     30        127.0.0.1        127.0.0.1      129       60      ESTABLISHED
*     31        127.0.0.1        127.0.0.1      130       62      ESTABLISHED
*     32        127.0.0.1        127.0.0.1      131       64      ESTABLISHED
*     33        127.0.0.1        127.0.0.1      132       66      ESTABLISHED
*     34        127.0.0.1        127.0.0.1      133       68      ESTABLISHED
*     35        127.0.0.1        127.0.0.1      134       70      ESTABLISHED
*     36        127.0.0.1        127.0.0.1      135       72      ESTABLISHED
*     37        127.0.0.1        127.0.0.1      136       74      ESTABLISHED
*     38        127.0.0.1        127.0.0.1      137       76      ESTABLISHED
*     39        127.0.0.1        127.0.0.1      138       78      ESTABLISHED
*     40        127.0.0.1        127.0.0.1      139       80      ESTABLISHED
*     41        127.0.0.1        127.0.0.1      140       82      ESTABLISHED
*     42        127.0.0.1        127.0.0.1      141       84      ESTABLISHED
*     43        127.0.0.1        127.0.0.1      142       86      ESTABLISHED
*     44        127.0.0.1        127.0.0.1      143       88      ESTABLISHED
*     45        127.0.0.1        127.0.0.1      144       90      ESTABLISHED
*     46        127.0.0.1        127.0.0.1      145       92      ESTABLISHED
*     47        127.0.0.1        127.0.0.1      146       94      ESTABLISHED
*     48        127.0.0.1        127.0.0.1      147       96      ESTABLISHED
*     49        127.0.0.1        127.0.0.1      148       98      ESTABLISHED
     100        127.0.0.1        127.0.0.1        1        1      ESTABLISHED
     101        127.0.0.1        127.0.0.1        2        3      ESTABLISHED
     102        127.0.0.1        127.0.0.1        3        5      ESTABLISHED
     103        127.0.0.1        127.0.0.1        4        7      ESTABLISHED
     104        127.0.0.1        127.0.0.1        5        9      ESTABLISHED
     105        127.0.0.1        127.0.0.1        6       11      ESTABLISHED
     106        127.0.0.1        127.0.0.1        7       13      ESTABLISHED
     107        127.0.0.1        127.0.0.1        8       15      ESTABLISHED
     108        127.0.0.1        127.0.0.1        9       17      ESTABLISHED
     109        127.0.0.1        127.0.0.1       10       19      ESTABLISHED
     110        127.0.0.1        127.0.0.1       11       21      ESTABLISHED
     111        127.0.0.1        127.0.0.1       12       23      ESTABLISHED
     112        127.0.0.1        127.0.0.1       13       25      ESTABLISHED
     113        127.0.0.1        127.0.0.1       14       27      ESTABLISHED
     114        127.0.0.1        127.0.0.1       15       29      ESTABLISHED
     115        127.0.0.1        127.0.0.1       16       31      ESTABLISHED
     116        127.0.0.1        127.0.0.1       17       33      ESTABLISHED
     117        127.0.0.1        127.0.0.1       18       35      ESTABLISHED
     118        127.0.0.1        127.0.0.1       19       37      ESTABLISHED
     119        127.0.0.1        127.0.0.1       20       39      ESTABLISHED
     120        127.0.0.1        127.0.0.1       21       41      ESTABLISHED
     121        127.0.0.1        127.0.0.1       22       43      ESTABLISHED
     122        127.0.0.1        127.0.0.1       23       45      ESTABLISHED
     123        127.0.0.1        127.0.0.1       24       47      ESTABLISHED
     124        127.0.0.1        127.0.0.1       25       49      ESTABLISHED
     125        127.0.0.1        127.0.0.1       26       51      ESTABLISHED
     126        127.0.0.1        127.0.0.1       27       53      ESTABLISHED
     127        127.0.0.1        127.0.0.1       28       55      ESTABLISHED
     128        127.0.0.1        127.0.0.1       29       57      ESTABLISHED
     129        127.0.0.1        127.0.0.1       30       59      ESTABLISHED
     130        127.0.0.1        127.0.0.1       31       61      ESTABLISHED
     131        127.0.0.1        127.0.0.1       32       63      ESTABLISHED
     132        127.0.0.1        127.0.0.1       33       65      ESTABLISHED
     133        127.0.0.1        127.0.0.1       34       67      ESTABLISHED
     134        127.0.0.1        127.0.0.1       35       69      ESTABLISHED
     135        127.0.0.1        127.0.0.1       36       71      ESTABLISHED
     136        127.0.0.1        127.0.0.1       37       73      ESTABLISHED
     137        127.0.0.1        127.0.0.1       38       75      ESTABLISHED
     138        127.0.0.1        127.0.0.1       39       77      ESTABLISHED
     139        127.0.0.1        127.0.0.1       40       79      ESTABLISHED
     140        127.0.0.1        127.0.0.1       41       81      ESTABLISHED
     141        127.0.0.1        127.0.0.1       42       83      ESTABLISHED
     142        127.0.0.1        127.0.0.1       43       85      ESTABLISHED
     143        127.0.0.1        127.0.0.1       44       87      ESTABLISHED
     144        127.0.0.1        127.0.0.1       45       89      ESTABLISHED
     145        127.0.0.1        127.0.0.1       46       91      ESTABLISHED
     146        127.0.0.1        127.0.0.1       47       93      ESTABLISHED
     147        127.0.0.1        127.0.0.1       48       95      ESTABLISHED
     148        127.0.0.1        127.0.0.1       49       97      ESTABLISHED
Deleted tunnel 100
Deleted tunnel 101
Deleted tunnel 102
Deleted tunnel 103
Deleted tunnel 104
Deleted tunnel 105
Deleted tunnel 106
Deleted tunnel 107
Deleted tunnel 108
Deleted tunnel 109
Deleted tunnel 110
Deleted tunnel 111
Deleted tunnel 112
Deleted tunnel 113
Deleted tunnel 114
Deleted tunnel 115
Deleted tunnel 116
Deleted tunnel 117
Deleted tunnel 118
Deleted tunnel 119
Deleted tunnel 120
Deleted tunnel 121
Deleted tunnel 122
Deleted tunnel 123
Deleted tunnel 124
Deleted tunnel 125
Deleted tunnel 126
Deleted tunnel 127
Deleted tunnel 128
Deleted tunnel 129
Deleted tunnel 130
Deleted tunnel 131
Deleted tunnel 132
Deleted tunnel 133
Deleted tunnel 134
Deleted tunnel 135
Deleted tunnel 136
Deleted tunnel 137
Deleted tunnel 138
Deleted tunnel 139
Deleted tunnel 140
Deleted tunnel 141
Deleted tunnel 142
Deleted tunnel 143
Deleted tunnel 144
Deleted tunnel 145
Deleted tunnel 146
Deleted tunnel 147
Deleted tunnel 148
L2TP service status:-
  tunnels: 0, sessions: 0

}

proc createDeleteSessions { tunnelName maxSessions } {
    global message

    clearResult

    for { set i 1 } { $i < $maxSessions } { incr i } {
	l2tpConfig -q session create tunnel_name=$tunnelName \
	    tunnel_name=$i
    }

    for { set i 1 } { $i < $maxSessions } { incr i } {
	l2tpConfig -q session delete tunnel_name=$tunnelName tunnel_name=$i
    }

    return $message
}

test tunnel-9.4 { Stress test tunnel setup/cleanup } \
    { l2tpdRunning && tunnel } \
    {
        global message

	clearResult
	l2tpConfig test log message=tunnel-9.4
	l2tpConfig test modify reset_ids no_random_ids=on

	# When in this loop, expect to see tunnel create failures
	# (tunnel already exists) and delete failures (tunnel
	# does not exist), since we create/delete tunnels as 
	# fast as possible. Once out of the loop, let things settle,
	# then retry the test and enable ping for each tunnel
	# to test system operation.

	for { set pass 1 } { $pass <= 20 } { incr pass } {
	    l2tpConfig test log message="Pass $pass"

	    clearResult

	    for { set i 1 } { $i <= 20 } { incr i } {
		l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_name=$i
	    }
	    for { set i 20 } { $i > 0 } { incr i -1 } {
		l2tpConfig tunnel delete tunnel_name=$i
	    }
	    sleep 2
	}
	for { set i 1 } { $i <= 20 } { incr i } {
	    l2tpConfig tunnel delete tunnel_name=$i
	}

	# Let the system settle

	sleep 180
	clearResult

	# Check system status
	
	l2tpConfig tunnel list
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1 tunnel_name=one
	sleep 2
	l2tpConfig tunnel list

	# Clean up

	l2tpConfig tunnel delete tunnel_name=one
	sleep 5
	l2tpConfig tunnel list
    } \
    {

Modified test config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Deleted tunnel one

}

############################################################################
# Tests 10.*
# Resilience under bad network condition (packet loss)
############################################################################

test tunnel-10.1 { Tunnel survives transmit packet loss } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-10.1
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig system modify reset_statistics

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig test modify clear_trigger
	l2tpConfig test modify fake_tx_drop=yes fake_trigger_type=once tunnel_id=1
	sleep 200
	l2tpConfig system show status
	l2tpConfig tunnel list

	l2tpConfig test modify fake_tx_drop=no fake_trigger_type=off tunnel_id=0
	l2tpConfig tunnel delete tunnel_id=1
	sleep 70
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
Modified test config
L2TP service status:-
  tunnels: 2, sessions: 0
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
Deleted tunnel 1

}

test tunnel-10.2 { Tunnel survives receive packet loss } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-10.2
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig system modify reset_statistics

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1
	sleep 62
	l2tpConfig tunnel list
	l2tpConfig test modify fake_rx_drop=yes fake_trigger_type=once tunnel_id=1
	sleep 200
	l2tpConfig system show status
	l2tpConfig tunnel list

	l2tpConfig test modify fake_rx_drop=no fake_trigger_type=off tunnel_id=0
	l2tpConfig tunnel delete tunnel_id=1
	sleep 65
	l2tpConfig tunnel list
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
L2TP service status:-
  tunnels: 2, sessions: 0
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
Deleted tunnel 1

}

test tunnel-10.3 { Tunnel deletes itself if network link fails } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-10.3
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig system modify reset_statistics

	l2tpConfig tunnel create dest_ipaddr=127.0.0.1 tunnel_id=1
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig test modify fake_rx_drop=yes fake_tx_drop=yes fake_trigger_type=on
	sleep 200
	l2tpConfig system show status
	l2tpConfig system show statistics
	l2tpConfig tunnel list

	l2tpConfig test modify fake_rx_drop=no fake_tx_drop=no fake_trigger_type=off
    } \
    {

Modified test config
Modified system config
Created tunnel 1
   TunId             Peer            Local  PeerTId ConfigId            State
       1        127.0.0.1        127.0.0.1        2        1      ESTABLISHED
*      2        127.0.0.1        127.0.0.1        1        2      ESTABLISHED
Modified test config
L2TP service status:-
  tunnels: 0, sessions: 0
L2TP counters:-
  Total messages sent: 3, received: 3, retransmitted: 14
    illegal: 0, unsupported: 0, ignored AVPs: 0, vendor AVPs: 0
  Setup failures: tunnels: 0, sessions: 0
  Resource failures: control frames: 0, peers: 0
    tunnels: 0, sessions: 0, ppp: 0
  Limit exceeded errors: tunnels: 0, sessions: 0
  Frame errors: short frames: 0, wrong version frames: 0
     unexpected data frames: 0, bad frames: 0
  Internal: authentication failures: 0, message encode failures: 0
     no matching tunnel discards: 0, mismatched tunnel ids: 0
     no matching session_discards: 0, mismatched session ids: 0
     total control frame send failures: 0, event queue fulls: 0

  Message counters:-
         Message          RX Good           RX Bad               TX
         ILLEGAL                0                0                0
           SCCRQ                1                0                1
           SCCRP                1                0                1
           SCCCN                1                0                1
         STOPCCN                0                0                0
       RESERVED1                0                0                0
           HELLO                0                0                0
            OCRQ                0                0                0
            OCRP                0                0                0
            OCCN                0                0                0
            ICRQ                0                0                0
            ICRP                0                0                0
            ICCN                0                0                0
       RESERVED2                0                0                0
             CDN                0                0                0
             WEN                0                0                0
             SLI                0                0                0

Modified test config
}

############################################################################
# Tests 11.* - config save/restore
############################################################################

test tunnel-11.0 { Config save/restore setup } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.0
	l2tpConfig test modify reset_ids no_random_ids=on default_config
	l2tpConfig system modify reset_statistics
    } \
    {

Modified test config
Modified system config
}

test tunnel-11.1 { Save created tunnels, check tunnel_name is auto-generated } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.1
	l2tpConfig test modify reset_ids no_random_ids=on
        l2tpConfig tunnel create dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 tunnel_id=50 config_id=50
        l2tpConfig tunnel create dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 tunnel_id=51 config_id=51 tunnel_name=one
	sleep 5
	l2tpConfig config save file=results/tunnel-11.1.cfg
	catFile results/tunnel-11.1.cfg
	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig tunnel delete tunnel_id=51
	sleep 62
	addCrLf
    } \
    {

Modified test config
Created tunnel 50
Created tunnel 51

$
# system$
$
# peer profiles$
$
# tunnel profiles$
$
# session profiles$
$
# ppp profiles$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=one dest_ipaddr=10.0.0.1 \$
	tunnel_id=51 \$
	config_id=51 \$
	src_ipaddr=127.0.0.1 \$
$
tunnel create tunnel_name=l2tp50 dest_ipaddr=10.0.0.1 \$
	tunnel_id=50 \$
	config_id=50 \$
	src_ipaddr=127.0.0.1 \$
$
Deleted tunnel 50
Deleted tunnel 51
}

test tunnel-11.2 { Save all set parameters of a tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.2
	l2tpConfig test modify reset_ids no_random_ids=on

	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble
	sleep 1

	l2tpConfig tunnel create tunnel_id=52 config_id=52 dest_ipaddr=10.0.0.1 \
	  tunnel_name=complex \
	  profile_name=wibble \
	  interface_name=wibble \
	  src_ipaddr=127.0.0.1 \
	  our_udp_port=1701 \
	  peer_udp_port=5000 \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  host_name=wibble \
	  secret=wibble \
	  hide_avps=yes \
	  use_tiebreaker=yes \
	  auth_mode=none \
	  allow_ppp_proxy=yes \
	  framing_caps=async \
	  bearer_caps=analog \
	  do_pmtu_discovery=yes \
	  mtu=1400 \
	  trace_flags=7 \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  rx_window_size=42 \
	  tx_window_size=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  max_sessions=42
	sleep 5
	l2tpConfig config save file=results/tunnel-11.2.cfg
	catFile results/tunnel-11.2.cfg
	l2tpConfig tunnel delete tunnel_id=52
	sleep 62
	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 2
	addCrLf
    } \
    {

Modified test config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 52

$
# system$
$
# peer profiles$
peer profile create profile_name=wibble$
$
# tunnel profiles$
tunnel profile create profile_name=wibble$
$
# session profiles$
session profile create profile_name=wibble$
$
# ppp profiles$
ppp profile create profile_name=wibble$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=complex dest_ipaddr=10.0.0.1 \$
	tunnel_id=52 \$
	config_id=52 \$
	hide_avps=yes \$
	auth_mode=none \$
	framing_cap=async \$
	bearer_cap=analog \$
	use_tiebreaker=yes \$
	hello_timeout=42 \$
	max_retries=42 \$
	rx_window_size=42 \$
	tx_window_size=42 \$
	retry_timeout=42 \$
	idle_timeout=42 \$
	secret=wibble \$
	allow_ppp_proxy=yes \$
	trace_flags=7 \$
	use_udp_checksums=no \$
	host_name=wibble \$
	max_sessions=42 \$
	src_ipaddr=127.0.0.1 \$
	our_udp_port=1701 \$
	peer_udp_port=5000 \$
	peer_profile_name=wibble \$
	session_profile_name=wibble \$
	ppp_profile_name=wibble \$
	do_pmtu_discovery=yes \$
	mtu=1400 \$
$
Deleted tunnel 52
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
}

test tunnel-11.3 { Save only non-default parameters of a created tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.3
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig tunnel create tunnel_id=53 config_id=53 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 \
	  interface_name=wibble \
	  host_name=wibble \
	  secret=wibble \
	  hide_avps=yes \
	  mtu=1400 \
	  trace_flags=7
	sleep 5
	l2tpConfig config save file=results/tunnel-11.3.cfg
	catFile results/tunnel-11.3.cfg
	l2tpConfig tunnel delete tunnel_id=53
	sleep 62
	addCrLf
    } \
    {

Modified test config
Created tunnel 53

$
# system$
$
# peer profiles$
$
# tunnel profiles$
$
# session profiles$
$
# ppp profiles$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=l2tp53 dest_ipaddr=10.0.0.1 \$
	tunnel_id=53 \$
	config_id=53 \$
	hide_avps=yes \$
	secret=wibble \$
	trace_flags=7 \$
	host_name=wibble \$
	src_ipaddr=127.0.0.1 \$
	mtu=1400 \$
$
Deleted tunnel 53
}

test tunnel-11.4 { Save all modified values of a tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.4
	l2tpConfig test modify reset_ids no_random_ids=on

	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble

	l2tpConfig tunnel create tunnel_id=54 config_id=54 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 
	l2tpConfig tunnel modify tunnel_id=54 \
	  tunnel_name=wibble \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  mtu=1400 \
	  trace_flags=7 \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  max_sessions=42
	sleep 5
	l2tpConfig config save file=results/tunnel-11.4.cfg
	catFile results/tunnel-11.4.cfg
	l2tpConfig tunnel delete tunnel_id=54
	sleep 62

	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 2
	addCrLf
    } \
    {

Modified test config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 54
Modified tunnel 54

$
# system$
$
# peer profiles$
peer profile create profile_name=wibble$
$
# tunnel profiles$
tunnel profile create profile_name=wibble$
$
# session profiles$
session profile create profile_name=wibble$
$
# ppp profiles$
ppp profile create profile_name=wibble$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=wibble dest_ipaddr=10.0.0.1 \$
	tunnel_id=54 \$
	config_id=54 \$
	hello_timeout=42 \$
	max_retries=42 \$
	retry_timeout=42 \$
	idle_timeout=42 \$
	trace_flags=7 \$
	use_udp_checksums=no \$
	max_sessions=42 \$
	src_ipaddr=127.0.0.1 \$
	peer_profile_name=wibble \$
	session_profile_name=wibble \$
	ppp_profile_name=wibble \$
	mtu=1400 \$
$
Deleted tunnel 54
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
}

test tunnel-11.5 { Save only non-default modified values of a tunnel } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.5
	l2tpConfig test modify reset_ids no_random_ids=on

	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble

	l2tpConfig tunnel create tunnel_id=55 config_id=55 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 
	l2tpConfig tunnel modify tunnel_id=55 \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  mtu=1400 \
	  trace_flags=7
	sleep 5
	l2tpConfig config save file=results/tunnel-11.5.cfg
	catFile results/tunnel-11.5.cfg
	l2tpConfig tunnel delete tunnel_id=55
	sleep 62

	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 2
	addCrLf
    } \
    {

Modified test config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 55
Modified tunnel 55

$
# system$
$
# peer profiles$
peer profile create profile_name=wibble$
$
# tunnel profiles$
tunnel profile create profile_name=wibble$
$
# session profiles$
session profile create profile_name=wibble$
$
# ppp profiles$
ppp profile create profile_name=wibble$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=l2tp55 dest_ipaddr=10.0.0.1 \$
	tunnel_id=55 \$
	config_id=55 \$
	trace_flags=7 \$
	src_ipaddr=127.0.0.1 \$
	session_profile_name=wibble \$
	ppp_profile_name=wibble \$
	mtu=1400 \$
$
Deleted tunnel 55
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
}

test tunnel-11.6 { Save all locally created tunnels } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.6
	l2tpConfig test modify reset_ids no_random_ids=on

        l2tpConfig tunnel create dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 tunnel_id=50 config_id=50 tunnel_name=one
        l2tpConfig tunnel create dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 tunnel_id=51 config_id=51 tunnel_name=two
        l2tpConfig tunnel create dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 tunnel_id=52 config_id=52 tunnel_name=three
	sleep 5
	l2tpConfig config save file=results/tunnel-11.6.cfg
	catFile results/tunnel-11.6.cfg
	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig tunnel delete tunnel_id=51
	l2tpConfig tunnel delete tunnel_id=52
	sleep 62
	addCrLf
    } \
    {

Modified test config
Created tunnel 50
Created tunnel 51
Created tunnel 52

$
# system$
$
# peer profiles$
$
# tunnel profiles$
$
# session profiles$
$
# ppp profiles$
$
# locally created tunnels and sessions$
tunnel create tunnel_name=three dest_ipaddr=10.0.0.1 \$
	tunnel_id=52 \$
	config_id=52 \$
	src_ipaddr=127.0.0.1 \$
$
tunnel create tunnel_name=two dest_ipaddr=10.0.0.1 \$
	tunnel_id=51 \$
	config_id=51 \$
	src_ipaddr=127.0.0.1 \$
$
tunnel create tunnel_name=one dest_ipaddr=10.0.0.1 \$
	tunnel_id=50 \$
	config_id=50 \$
	src_ipaddr=127.0.0.1 \$
$
Deleted tunnel 50
Deleted tunnel 51
Deleted tunnel 52
}

test tunnel-11.7 { Restore all parameters of a tunnel from a saved file } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.7
	l2tpConfig test modify reset_ids no_random_ids=on

	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble
	sleep 2

	l2tpConfig tunnel create tunnel_id=50 config_id=50 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 \
	  tunnel_name=wibble \
	  secret=wibble \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  mtu=1400 \
	  trace_flags=7 \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  retry_timeout=42 \
	  idle_timeout=42 \
	  max_sessions=42
	sleep 5
	l2tpConfig tunnel list
	l2tpConfig test log message=tunnel-11.7-save
	l2tpConfig config save file=results/tunnel-11.7.cfg
	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 62

	l2tpConfig test log message=tunnel-11.7-restore
	l2tpConfig config restore file=results/tunnel-11.7.cfg
	l2tpConfig tunnel list
	l2tpConfig tunnel show tunnel_id=50 config
	l2tpConfig tunnel delete tunnel_id=50
	sleep 62

	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 2
	addCrLf
    } \
    {

Modified test config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 50
   TunId             Peer            Local  PeerTId ConfigId            State
      50         10.0.0.1        127.0.0.1        0       50     WAITCTLREPLY


Deleted tunnel 50
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble

Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 50
   TunId             Peer            Local  PeerTId ConfigId            State
      50         10.0.0.1        127.0.0.1        0       50     WAITCTLREPLY
Tunnel 50, from 127.0.0.1 to 10.0.0.1, config_id 50:-
  state: WAITCTLREPLY
  administrative name: 'wibble'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: wibble, ppp profile: wibble
  hello timeout: 42, retry timeout: 42, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 50
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
}

test tunnel-11.8 { Restore multiple tunnels } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-11.8
	l2tpConfig test modify reset_ids no_random_ids=on
	l2tpConfig peer profile create profile_name=wibble
	l2tpConfig tunnel profile create profile_name=wibble
	l2tpConfig session profile create profile_name=wibble
	l2tpConfig ppp profile create profile_name=wibble

	l2tpConfig tunnel create tunnel_id=50 config_id=50 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 \
	  tunnel_name=one \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble
	l2tpConfig tunnel create tunnel_id=51 config_id=51 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 \
	  tunnel_name=two \
	  mtu=1400 \
	  trace_flags=0xffffffff \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  retry_timeout=2 \
	  idle_timeout=42
	l2tpConfig tunnel create tunnel_id=52 config_id=52 dest_ipaddr=10.0.0.1 src_ipaddr=127.0.0.1 \
	  tunnel_name=three \
	  secret=wibble \
	  peer_profile_name=wibble \
	  session_profile_name=wibble \
	  ppp_profile_name=wibble \
	  mtu=1400 \
	  trace_flags=7 \
	  use_udp_checksums=no \
	  hello_timeout=42 \
	  max_retries=42 \
	  retry_timeout=2 \
	  idle_timeout=42 \
	  max_sessions=42
	sleep 5
	l2tpConfig test log message="saving tunnel-11.8.cfg..."
	l2tpConfig config save file=results/tunnel-11.8.cfg

	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig tunnel delete tunnel_id=51
	l2tpConfig tunnel delete tunnel_id=52
	sleep 62

	l2tpConfig test log message="loading tunnel-11.8.cfg..."
	l2tpConfig config restore file=results/tunnel-11.8.cfg

	l2tpConfig tunnel list
	l2tpConfig tunnel show tunnel_id=50 config
	l2tpConfig tunnel show tunnel_id=51 config
	l2tpConfig tunnel show tunnel_id=52 config

	l2tpConfig tunnel delete tunnel_id=50
	l2tpConfig tunnel delete tunnel_id=51
	l2tpConfig tunnel delete tunnel_id=52
	sleep 62

	l2tpConfig ppp profile delete profile_name=wibble
	l2tpConfig session profile delete profile_name=wibble
	l2tpConfig tunnel profile delete profile_name=wibble
	l2tpConfig peer profile delete profile_name=wibble
	sleep 2
	addCrLf
    } \
    {

Modified test config
Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 50
Created tunnel 51
Created tunnel 52


Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
Deleted tunnel 50
Deleted tunnel 51
Deleted tunnel 52

Created peer profile wibble
Created tunnel profile wibble
Created session profile wibble
Created ppp profile wibble
Created tunnel 52
Created tunnel 51
Created tunnel 50
   TunId             Peer            Local  PeerTId ConfigId            State
      50         10.0.0.1        127.0.0.1        0       50     WAITCTLREPLY
      51         10.0.0.1        127.0.0.1        0       51     WAITCTLREPLY
      52         10.0.0.1        127.0.0.1        0       52     WAITCTLREPLY
Tunnel 50, from 127.0.0.1 to 10.0.0.1, config_id 50:-
  state: WAITCTLREPLY
  administrative name: 'one'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: wibble, ppp profile: wibble
  hello timeout: 60, retry timeout: 1, idle timeout: 0
  rx window size: 10, tx window size: 10, max retries: 5
  use udp checksums: ON
  do pmtu discovery: OFF, mtu: 1460
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 51, from 127.0.0.1 to 10.0.0.1, config_id 51:-
  state: WAITCTLREPLY
  administrative name: 'two'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  session limit: 0, session count: 0
  tunnel profile: default, peer profile: default
  session profile: default, ppp profile: default
  hello timeout: 42, retry timeout: 2, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Tunnel 52, from 127.0.0.1 to 10.0.0.1, config_id 52:-
  state: WAITCTLREPLY
  administrative name: 'three'
  created by admin: YES, tunnel mode: LAC
  peer tunnel id: 0, host name: NOT SET
  UDP ports: local 0, peer 0
  authorization mode: NONE, hide AVPs: OFF, allow PPP proxy: OFF
  tunnel secret: 'wibble'
  session limit: 42, session count: 0
  tunnel profile: default, peer profile: wibble
  session profile: wibble, ppp profile: wibble
  hello timeout: 42, retry timeout: 2, idle timeout: 42
  rx window size: 10, tx window size: 10, max retries: 42
  use udp checksums: OFF
  do pmtu discovery: OFF, mtu: 1400
  framing capability: SYNC ASYNC, bearer capability: DIGITAL ANALOG
  use tiebreaker: OFF
  trace flags: PROTOCOL FSM API
  peer protocol version: 0.0, firmware 0
  peer framing capability: NONE
  peer bearer capability: NONE
  peer rx window size: 0
Deleted tunnel 50
Deleted tunnel 51
Deleted tunnel 52
Deleted ppp profile wibble
Deleted session profile wibble
Deleted tunnel profile wibble
Deleted peer profile wibble
}

############################################################################
# Tests 12.* - debug control
############################################################################

test tunnel-12.1 { Debug modify tunnel all=yes } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.1
	l2tpConfig tunnel create tunnel_id=1 dest_ipaddr=10.0.0.1 config_id=1 src_ipaddr=127.0.0.1
	l2tpConfig debug modify tunnel_id=1 all=yes
	l2tpConfig debug show tunnel_id=1
	l2tpConfig tunnel delete tunnel_id=1
    } \
    {

Created tunnel 1

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
Deleted tunnel 1
}

test tunnel-12.2 { Debug modify tunnel all=no } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.2
	l2tpConfig tunnel create tunnel_id=2 dest_ipaddr=10.0.0.1 config_id=2 src_ipaddr=127.0.0.1
	l2tpConfig debug modify tunnel_id=2 all=no
	l2tpConfig debug show tunnel_id=2
	l2tpConfig tunnel delete tunnel_id=2
    } \
    {

Created tunnel 2

  trace flags: NONE
Deleted tunnel 2
}

test tunnel-12.3 { Debug modify tunnel incremental changes } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.3
	l2tpConfig tunnel create tunnel_id=3 dest_ipaddr=10.0.0.1 config_id=3 src_ipaddr=127.0.0.1
	l2tpConfig debug modify tunnel_id=3 all=no
	l2tpConfig debug modify tunnel_id=3 protocol=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_info=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_data=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_hide=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 fsm=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 api=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 ppp_control=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 transport=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 func=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 data=yes
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 system=yes
	l2tpConfig debug show tunnel_id=3
	# check every flag is set
	l2tpConfig debug modify tunnel_id=3 all=yes
	l2tpConfig debug show tunnel_id=3
	# Turn each off again
	l2tpConfig debug modify tunnel_id=3 protocol=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_info=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_data=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 avp_hide=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 fsm=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 api=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 ppp_control=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 transport=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 func=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 data=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig debug modify tunnel_id=3 system=no
	l2tpConfig debug show tunnel_id=3
	# check every flag is unset
	l2tpConfig debug modify tunnel_id=3 all=no
	l2tpConfig debug show tunnel_id=3
	l2tpConfig tunnel delete tunnel_id=3
    } \
    {

Created tunnel 3


  trace flags: PROTOCOL

  trace flags: PROTOCOL AVP

  trace flags: PROTOCOL AVP AVPDATA

  trace flags: PROTOCOL AVP AVPHIDE AVPDATA

  trace flags: PROTOCOL FSM AVP AVPHIDE AVPDATA

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA PPP

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA XPRT PPP

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT PPP

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM

  trace flags: FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM

  trace flags: FSM API AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM

  trace flags: FSM API AVPHIDE FUNC XPRT DATA PPP SYSTEM

  trace flags: FSM API FUNC XPRT DATA PPP SYSTEM

  trace flags: API FUNC XPRT DATA PPP SYSTEM

  trace flags: FUNC XPRT DATA PPP SYSTEM

  trace flags: FUNC XPRT DATA SYSTEM

  trace flags: FUNC DATA SYSTEM

  trace flags: DATA SYSTEM

  trace flags: SYSTEM

  trace flags: NONE

  trace flags: NONE
Deleted tunnel 3
}

test tunnel-12.4 { Debug modify tunnel group changes } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.4
	l2tpConfig tunnel create tunnel_id=4 dest_ipaddr=10.0.0.1 config_id=4 src_ipaddr=127.0.0.1
	l2tpConfig debug modify tunnel_id=4 all=no
	l2tpConfig debug modify tunnel_id=4 protocol=yes avp_info=yes fsm=yes
	l2tpConfig debug show tunnel_id=4
	l2tpConfig debug modify tunnel_id=4 api=yes avp_hide=yes avp_data=yes system=yes ppp_control=yes func=yes
	l2tpConfig debug show tunnel_id=4
	l2tpConfig debug modify tunnel_id=4 protocol=no fsm=no
	l2tpConfig debug show tunnel_id=4
	l2tpConfig debug modify tunnel_id=4 avp_info=no avp_data=no avp_hide=no
	l2tpConfig debug show tunnel_id=4
	l2tpConfig tunnel delete tunnel_id=4
    } \
    {

Created tunnel 4


  trace flags: PROTOCOL FSM AVP

  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC PPP SYSTEM

  trace flags: API AVP AVPHIDE AVPDATA FUNC PPP SYSTEM

  trace flags: API FUNC PPP SYSTEM
Deleted tunnel 4
}

test tunnel-12.5 { Debug modify tunnel bad trace category } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.5
	l2tpConfig tunnel create tunnel_id=5 dest_ipaddr=10.0.0.1 config_id=5 src_ipaddr=127.0.0.1
	l2tpConfig debug modify tunnel_id=5 all=no
	l2tpConfig debug modify tunnel_id=5 wibble=yes
	l2tpConfig debug show tunnel_id=5
	l2tpConfig tunnel delete tunnel_id=5
    } \
    {

Created tunnel 5

Error at or near 'wibble=yes'
  trace flags: NONE
Deleted tunnel 5
}

test tunnel-12.6 { Set tunnel trace_flags symbolically } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.6
	l2tpConfig tunnel create tunnel_id=6 dest_ipaddr=10.0.0.1 config_id=6 src_ipaddr=127.0.0.1
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=all
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=protocol
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=api,fsm
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=avp_info,avp_data,avp_hide
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=api,protocol,fsm,avp_info,avp_data,avp_hide,ppp_control,transport,system,data,func
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel modify tunnel_id=6 trace_flags=all
	l2tpConfig debug show tunnel_id=6
	l2tpConfig tunnel delete tunnel_id=6
    } \
    {

Created tunnel 6
Modified tunnel 6
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
Modified tunnel 6
  trace flags: PROTOCOL
Modified tunnel 6
  trace flags: FSM API
Modified tunnel 6
  trace flags: AVP AVPHIDE AVPDATA
Modified tunnel 6
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
Modified tunnel 6
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
Deleted tunnel 6
}

test tunnel-12.7 { Detect bad trace category in command } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.7
	l2tpConfig tunnel create tunnel_id=7 dest_ipaddr=10.0.0.1 config_id=7 src_ipaddr=127.0.0.1
	l2tpConfig tunnel modify tunnel_id=7 trace_flags=all
	l2tpConfig tunnel modify tunnel_id=7 trace_flags=api,protocol,fsm,avp_info,avp_data,avp_hide,wibble,data,func
	l2tpConfig debug show tunnel_id=7
	l2tpConfig tunnel delete tunnel_id=7
    } \
    {

Created tunnel 7
Modified tunnel 7
Error at or near 'modify'
Unknown trace flag: wibble
  trace flags: PROTOCOL FSM API AVP AVPHIDE AVPDATA FUNC XPRT DATA PPP SYSTEM
Deleted tunnel 7
}

test tunnel-12.99 { Cleanup } \
    { l2tpdRunning && tunnel } \
    { \
	clearResult
	l2tpConfig test log message=tunnel-12.99
	# wait for test tunnels to delete
	sleep 62
	l2tpConfig test modify default_config
    } \
    {

Modified test config
}

